<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scene 8: Katherine Johnson - SHE<Codes/></title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Courier New', monospace;
            background: #0a0a0a;
            overflow: hidden;
            height: 100vh;
        }

        /* Game Container */
        #game-container {
            position: relative;
            width: 100vw;
            height: 100vh;
            background: url('images/nasa-control-room.jpg') center center no-repeat;
            background-size: cover;
            background-color: #1a1a2a;
        }

        /* Time transition - space themed */
        .time-transition {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, #000428 0%, #004e92 50%, #000000 100%);
            z-index: 3000;
            animation: spaceTravel 3s ease-out forwards;
            pointer-events: none;
        }

        @keyframes spaceTravel {
            0% { opacity: 1; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.2); }
            100% { opacity: 0; transform: scale(1.5); }
        }

        .stars {
            position: absolute;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }

        .star {
            position: absolute;
            width: 2px;
            height: 2px;
            background: white;
            border-radius: 50%;
            animation: twinkle 2s ease-in-out infinite;
        }

        @keyframes twinkle {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 1; }
        }

        /* NASA Control Room Elements */
        .control-panel {
            position: absolute;
            top: 15%;
            left: 8%;
            width: 200px;
            height: 150px;
            background: linear-gradient(135deg, #2a2a3a 0%, #1a1a2a 100%);
            border: 3px solid #3a3a4a;
            border-radius: 5px;
        }

        .panel-lights {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            padding: 15px;
        }

        .indicator-light {
            width: 100%;
            height: 20px;
            border-radius: 3px;
            animation: blink 2s ease-in-out infinite;
        }

        .light-red { background: #ff0000; animation-delay: 0s; }
        .light-green { background: #00ff00; animation-delay: 0.5s; }
        .light-yellow { background: #ffff00; animation-delay: 1s; }
        .light-blue { background: #0088ff; animation-delay: 1.5s; }

        @keyframes blink {
            0%, 100% { opacity: 0.3; box-shadow: none; }
            50% { opacity: 1; box-shadow: 0 0 10px currentColor; }
        }

        .large-monitor {
            position: absolute;
            top: 12%;
            right: 10%;
            width: 250px;
            height: 180px;
            background: #0a0a0a;
            border: 5px solid #3a3a4a;
            border-radius: 5px;
            overflow: hidden;
        }

        .monitor-display {
            width: 100%;
            height: 100%;
            background: linear-gradient(to bottom, #001a00 0%, #000a00 100%);
            color: #00ff00;
            font-size: 0.7rem;
            padding: 10px;
            line-height: 1.4;
        }

        .trajectory-line {
            position: absolute;
            width: 100%;
            height: 2px;
            background: #ff0000;
            top: 50%;
            animation: trajectoryShift 2s ease-in-out infinite;
        }

        @keyframes trajectoryShift {
            0%, 100% { transform: translateY(-10px); }
            50% { transform: translateY(10px); }
        }

        .trajectory-line.corrected {
            background: #00ff00;
            animation: none;
            transform: translateY(0);
        }

        /* Main Display - Blackboard */
        .blackboard-section {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 550px;
            height: 450px;
            z-index: 10;
        }

        .blackboard {
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #1a3a1a 0%, #0a2a0a 100%);
            border: 8px solid #654321;
            border-radius: 5px;
            position: relative;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.9);
        }

        .blackboard-content {
            padding: 30px;
            color: #ffffff;
            height: 100%;
            overflow-y: auto;
        }

        .equation-title {
            font-size: 1.3rem;
            color: #ffff99;
            margin-bottom: 15px;
            text-align: center;
            text-decoration: underline;
        }

        .equation-display {
            background: rgba(0, 0, 0, 0.3);
            border: 2px solid #556b2f;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 20px;
            font-size: 1rem;
            line-height: 1.8;
            color: #ffffcc;
        }

        .hint-box {
            background: rgba(139, 69, 19, 0.3);
            border: 2px solid #8b4513;
            border-radius: 5px;
            padding: 12px;
            margin-top: 15px;
            font-size: 0.85rem;
            color: #ffd700;
        }

        .chalk-text {
            text-shadow: 1px 1px 2px rgba(255, 255, 255, 0.3);
        }

        /* Katherine Johnson Character */
        .katherine-character {
            position: absolute;
            top: 48%;
            left: 18%;
            transform: translateY(-50%);
            width: 185px;
            height: 260px;
            z-index: 5;
            background-image: url('../../assets/Characterblue.png');
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
        }

        :root {
            --dialog-duration: 0.18s; /* default: snappy */
            --dialog-ease: cubic-bezier(.2,.9,.2,1);
            --dialog-opacity-duration: 0.12s;
        }

        /* Player Character */
        .player {
            position: absolute;
            bottom: 30%;
            right: 20%;
            width: 80px;
            height: 120px;
            background: linear-gradient(to bottom, #667eea 0%, #4a5aa8 100%);
            border-radius: 25px 25px 10px 10px;
            z-index: 100;
            opacity: 0;
            animation: playerAppear 1s ease-out 3s forwards;
            background-image: url('../../assets/Characterpink.png');
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
        }

        @keyframes playerAppear {
            0% { opacity: 0; transform: scale(0.5) translateY(-50px); }
            50% { opacity: 1; transform: scale(1.2) translateY(-10px); }
            100% { opacity: 1; transform: scale(1) translateY(0); }
        }

        .player::before {
            display: none;
        }

        /* Dialogue Box */
        .dialogue-box {
            position: absolute;
            /* anchored to lower part of the screen so it doesn't block the blackboard */
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%) translateY(-6px);
            width: min(72%, 720px);
            max-width: 720px;
            background: rgba(10, 10, 26, 0.95);
            border: 4px solid #0088ff;
            border-radius: 15px;
            padding: 16px 18px;
            color: #ffffff;
            display: none;
            z-index: 1000;
            opacity: 0;
            transition: transform 0.18s cubic-bezier(.2,.9,.2,1), opacity 0.12s cubic-bezier(.2,.9,.2,1);
            box-shadow: 0 0 30px rgba(0, 136, 255, 0.3);
        }

        .dialogue-box.active {
            display: block;
            /* visible state - animate to neutral position */
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }

        .dialogue-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #0088ff;
        }

        .dialogue-portrait {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #4a5a8a 0%, #2a3a5a 100%);
            border-radius: 50%;
            border: 3px solid #0088ff;
            margin-right: 15px;
        }

        .dialogue-name {
            font-size: 1.12rem;
            font-weight: bold;
            color: #0088ff;
        }

        .dialogue-text {
            /* slightly smaller text so the dialogue box takes up less screen height */
            font-size: 0.95rem;
            line-height: 1.8;
            margin-bottom: 15px;
        }

        /* responsive: keep dialog readable but compact on small screens */
        @media (max-width: 720px) {
            .dialogue-box { width: 92%; max-width: 92%; padding: 12px 14px; }
            .dialogue-text { font-size: 0.88rem; line-height: 1.6; }
            .dialogue-name { font-size: 1rem; }
            .dialogue-buttons { margin-top: 12px; gap: 10px; }
            .dialogue-btn { padding: 10px 22px; font-size: 0.95rem; }
        }

        .dialogue-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
        }

        /* small repositioning helper - when repositioning, briefly offset and animate back */
        /* repositioning helper removed â€” dialogues always anchored to bottom */

        .dialogue-btn {
            background: linear-gradient(135deg, #0088ff 0%, #0055cc 100%);
            border: 2px solid #00aaff;
            color: #ffffff;
            padding: 12px 30px;
            font-size: 1rem;
            font-weight: bold;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Courier New', monospace;
        }

        .dialogue-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 136, 255, 0.5);
            background: linear-gradient(135deg, #0099ff 0%, #0066dd 100%);
        }

        /* Coding Interface */
        .coding-interface {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.92);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .coding-interface.active {
            display: flex;
        }

        .code-panel {
            background: linear-gradient(135deg, #1a1a2a 0%, #0a0a1a 100%);
            border: 5px solid #0088ff;
            border-radius: 20px;
            padding: 30px;
            max-width: 900px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 136, 255, 0.4);
        }

        .code-title {
            font-size: 1.8rem;
            color: #0088ff;
            text-align: center;
            margin-bottom: 10px;
            text-shadow: 0 0 10px rgba(0, 136, 255, 0.5);
        }

        .code-instruction {
            color: #ffffff;
            text-align: center;
            font-size: 1.1rem;
            margin-bottom: 30px;
            line-height: 1.6;
        }

        .code-editor {
            background: #0a0a1a;
            border: 3px solid #2a2a3a;
            border-radius: 10px;
            padding: 25px;
            font-family: 'Courier New', monospace;
            font-size: 1rem;
            line-height: 1.8;
            color: #00ff00;
            margin-bottom: 20px;
        }

        .code-line {
            margin: 8px 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .line-number {
            color: #666;
            min-width: 30px;
            text-align: right;
            user-select: none;
        }

        .code-text {
            color: #00ff00;
        }

        .keyword {
            color: #ff6b9d;
            font-weight: bold;
        }

        .function-name {
            color: #4ecdc4;
        }

        .variable {
            color: #ffd700;
        }

        .comment {
            color: #888;
            font-style: italic;
        }

        .code-input {
            background: #1a1a2a;
            border: 2px solid #0088ff;
            border-radius: 5px;
            padding: 4px 8px;
            color: #ffd700;
            font-family: 'Courier New', monospace;
            font-size: 1rem;
            min-width: 100px;
            outline: none;
            transition: all 0.3s ease;
        }

        .code-input:focus {
            border-color: #00aaff;
            box-shadow: 0 0 10px rgba(0, 136, 255, 0.3);
        }

        .code-input.correct {
            border-color: #00ff00;
            background: rgba(0, 255, 0, 0.1);
        }

        .code-input.incorrect {
            border-color: #ff0000;
            background: rgba(255, 0, 0, 0.1);
            animation: shake 0.3s;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        .available-options {
            background: rgba(42, 42, 58, 0.6);
            border: 2px solid #2a2a3a;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .options-title {
            color: #0088ff;
            font-size: 1rem;
            margin-bottom: 10px;
            text-align: center;
        }

        .options-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
        }

        .option-chip {
            background: #2a2a3a;
            border: 2px solid #3a3a4a;
            border-radius: 15px;
            padding: 6px 15px;
            color: #00aaff;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
            user-select: none;
        }

        .option-chip:hover {
            background: #3a3a4a;
            border-color: #0088ff;
            transform: scale(1.05);
        }

        .option-chip.used {
            opacity: 0.3;
            cursor: default;
            pointer-events: none;
        }

        /* Visual indicator (soft) for chips that are currently used in any blank */
        .option-chip.in-use {
            box-shadow: 0 6px 18px rgba(0,170,255,0.25) inset, 0 8px 25px rgba(0,170,255,0.12);
            border-color: #00aaff;
            transform: translateY(-3px);
            transition: transform .12s ease, box-shadow .12s ease, border-color .12s ease;
        }

        .execute-code-btn {
            display: block;
            margin: 20px auto 0;
            background: linear-gradient(135deg, #00ff00 0%, #00aa00 100%);
            border: 3px solid #00ff00;
            color: #000000;
            padding: 15px 50px;
            font-size: 1.3rem;
            font-weight: bold;
            border-radius: 30px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Courier New', monospace;
            text-transform: uppercase;
        }

        .execute-code-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 25px rgba(0, 255, 0, 0.6);
        }

        .execute-code-btn:disabled {
            background: #333;
            border-color: #555;
            color: #666;
            cursor: not-allowed;
            opacity: 0.5;
        }

        /* Success Flash */
        .success-flash {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, rgba(0, 136, 255, 0.8) 0%, transparent 70%);
            opacity: 0;
            pointer-events: none;
            z-index: 2500;
        }

        .success-flash.active {
            animation: flashSuccess 1.5s ease-out;
        }

        @keyframes flashSuccess {
            0%, 100% { opacity: 0; }
            50% { opacity: 1; }
        }

        /* HUD */
        .hud {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(10, 10, 26, 0.9);
            border: 3px solid #0088ff;
            border-radius: 10px;
            padding: 15px;
            z-index: 1500;
        }

        .hud-title {
            color: #0088ff;
            font-size: 0.9rem;
            margin-bottom: 10px;
            text-align: center;
        }

        .repair-progress {
            display: flex;
            gap: 5px;
        }

        .repair-piece {
            width: 30px;
            height: 30px;
            border: 2px solid #2a2a3a;
            border-radius: 5px;
            background: #0a0a1a;
            transition: all 0.5s ease;
        }

        .repair-piece.active {
            background: linear-gradient(135deg, #0088ff 0%, #0055cc 100%);
            box-shadow: 0 0 15px rgba(0, 136, 255, 0.8);
            animation: piecePulse 1s ease-out;
            cursor: pointer;
        }

        .repair-piece.active:hover {
            transform: scale(1.15);
            box-shadow: 0 0 25px rgba(0, 136, 255, 1);
            border-color: #00aaff;
        }

        @keyframes piecePulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2); }
        }

        .logout-btn {
            margin-top: 10px;
            width: 100%;
            padding: 8px;
            background: linear-gradient(135deg, #8b0000 0%, #ff4444 100%);
            border: 2px solid #0088ff;
            border-radius: 5px;
            color: #ffffff;
            font-size: 0.85rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Courier New', monospace;
        }

        .logout-btn:hover {
            background: linear-gradient(135deg, #a00000 0%, #ff5555 100%);
            box-shadow: 0 0 10px rgba(255, 68, 68, 0.5);
            transform: translateY(-2px);
        }

        /* slideUp keyframes removed â€” dialog now uses transform+opacity transitions */

        /* Spacecraft visualization */
        .spacecraft-viz {
            position: absolute;
            top: 5px;
            left: 5px;
            right: 5px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .spacecraft-icon {
            font-size: 2rem;
            position: absolute;
            left: 10%;
            animation: driftOff 3s ease-in-out infinite;
        }

        @keyframes driftOff {
            0%, 100% { transform: translateY(-5px); }
            50% { transform: translateY(5px); }
        }

        .spacecraft-icon.corrected {
            animation: steadyFlight 1s ease-in-out infinite;
            left: 50%;
        }

        @keyframes steadyFlight {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-2px); }
        }
    </style>
</head>
<body>
    <div id="game-container">
        <!-- Time transition with stars -->
        <div class="time-transition" id="timeTransition">
            <div class="stars" id="stars"></div>
        </div>

        <!-- NASA Control Room Elements -->
        <div class="control-panel">
            <div class="panel-lights">
                <div class="indicator-light light-red"></div>
                <div class="indicator-light light-green"></div>
                <div class="indicator-light light-yellow"></div>
                <div class="indicator-light light-blue"></div>
                <div class="indicator-light light-green"></div>
                <div class="indicator-light light-red"></div>
                <div class="indicator-light light-blue"></div>
                <div class="indicator-light light-yellow"></div>
            </div>
        </div>

        <div class="large-monitor">
            <div class="monitor-display">
                <div class="spacecraft-viz">
                    <span class="spacecraft-icon" id="spacecraftIcon">ðŸš€</span>
                </div>
                COUNTDOWN STATUS:<br>
                <span id="trajectoryStatus" style="color: #ff0000;">SYSTEM ERROR</span><br>
                <div class="trajectory-line" id="trajectoryLine"></div>
                <br>
                CODE FIX REQUIRED<br>
                AWAITING PROGRAM...
            </div>
        </div>

        <!-- Blackboard Section -->
        <div class="blackboard-section">
            <div class="blackboard">
                <div class="blackboard-content chalk-text">
                    <div class="equation-title">Loop Structure for Calculations</div>
                    <div class="equation-display">
                        <strong>Given:</strong><br>
                        â€¢ Start position: x = 0<br>
                        â€¢ Steps needed: n = 10<br>
                        â€¢ Distance per step: d = 500 km<br>
                        â€¢ Loop variable: i (changes each time)<br><br>
                        <strong>Pattern:</strong><br>
                        for i in range(n):<br>
                        &nbsp;&nbsp;&nbsp;&nbsp;position = i Ã— d<br>
                        &nbsp;&nbsp;&nbsp;&nbsp;print("Step", i, "Position:", position)<br>
                    </div>
                    <div class="hint-box">
                        ðŸ’¡ <strong>Katherine's Note:</strong><br>
                        "Loops repeat calculations automatically! Each time through the loop, 'i' increases by 1. We use it to calculate the next position and print the result. This is how we track the spacecraft's journey step by step."
                    </div>
                </div>
            </div>
        </div>

        <!-- Katherine Johnson Character -->
        <div class="katherine-character"></div>

        <!-- Player Character -->
        <div class="player"></div>

        <!-- Dialogue Box -->
        <div class="dialogue-box" id="dialogueBox">
            <div class="dialogue-header">
                <div class="dialogue-portrait"></div>
                <div class="dialogue-name">Katherine Johnson</div>
            </div>
            <div class="dialogue-text" id="dialogueText"></div>
            <div class="dialogue-buttons" id="dialogueButtons"></div>
        </div>

        <!-- HUD -->
        <div class="hud">
            <div class="hud-title">Time Machine Repair</div>
            <div class="repair-progress">
                <div class="repair-piece" id="piece1" data-scene="SceneOne.html"></div>
                <div class="repair-piece" id="piece2" data-scene="SceneTwo.html"></div>
                <div class="repair-piece" id="piece3" data-scene="SceneThree.html"></div>
                <div class="repair-piece" id="piece4" data-scene="SceneFour.html"></div>
                <div class="repair-piece" id="piece5" data-scene="SceneFive.html"></div>
                <div class="repair-piece" id="piece6" data-scene="SceneSix.html"></div>
                <div class="repair-piece" id="piece7" data-scene="SceneSeven.html"></div>
                <div class="repair-piece" id="piece8" data-scene="SceneEight.html"></div>
            </div>
            <button class="logout-btn" onclick="handleLogout()">Logout</button>
        </div>
    </div>

    <!-- Coding Interface -->
    <div class="coding-interface" id="codingInterface">
        <div class="code-panel">
            <span class="code-title" style="color:#27d7ff;font-size:1.3rem;font-weight:bold;display:block;margin-top:10px;text-align:center;">ðŸ§© Code Skeleton (with blanks)</span>
            <div style="color:#b3e6ff;font-size:1rem;margin-bottom:8px;text-align:center;">What the player sees (with <span style="color:#ffd700;">???</span> as drop-zones):<br><em style="color:#7fd7ff;font-size:0.95rem;">You can use an option more than once!</em></div>
            <div class="available-options" style="margin-bottom:12px;">
                <div class="options-title" style="color:#27d7ff;font-size:1rem;margin-bottom:4px;">â—† Available Options:</div>
                <div class="options-list" style="display:flex;flex-wrap:wrap;gap:8px;justify-content:center;">
                    <div class="option-chip" data-value="print">print</div>
                    <div class="option-chip" data-value="if">if</div>
                    <div class="option-chip" data-value="for">for</div>
                    <div class="option-chip" data-value="in">in</div>
                    <div class="option-chip" data-value="range(1, 6)">range(1, 6)</div>
                    <div class="option-chip" data-value="second">second</div>
                    <div class="option-chip" data-value="5">5</div>
                    <div class="option-chip" data-value="while">while</div>
                    <div class="option-chip" data-value="range(5)">range(5)</div>
                    <div class="option-chip" data-value="time">time</div>
                    <div class="option-chip" data-value="1">1</div>
                    <div class="option-chip" data-value="else">else</div>
                </div>
            </div>
            <div class="code-editor" id="codeEditor" style="background:#181c2f;border-radius:12px;padding:18px 24px;margin-top:8px;">
                <div class="code-line" style="color:#888;font-size:1rem;margin-bottom:2px;">
                    <span class="comment"># Valentina's launch countdown</span>
                </div>
                <div class="code-line" style="font-size:1.1rem;">
                    <span style="color:#4c8bff;font-weight:bold;">for</span> <input class="code-input" id="input1" data-answer="second" style="width:90px;" placeholder="???"> <span style="color:#4c8bff;font-weight:bold;">in</span> <input class="code-input" id="input2" data-answer="range(1, 6)" style="width:120px;" placeholder="???">:
                </div>
                <div class="code-line" style="font-size:1.1rem;">
                    <input class="code-input" id="input3" data-answer="print" style="width:80px;" placeholder="???">(<span style="color:#27d7ff">"T-minus"</span>, <input class="code-input" id="input4" data-answer="second" style="width:90px;" placeholder="???">)
                </div>
                <div class="code-line" style="font-size:1.1rem;">
                    <span style="color:#4c8bff;font-weight:bold;">if</span> <input class="code-input" id="input5" data-answer="second" style="width:90px;" placeholder="???"> == <input class="code-input" id="input6" data-answer="5" style="width:60px;" placeholder="???">:
                </div>
                <div class="code-line" style="font-size:1.1rem;">
                    <span style="color:#ffb347;font-weight:bold;">print</span>(<span style="color:#39ff14">"LIFTOFF, VALENTINA!"</span>)
                </div>
            </div>
            <button class="execute-code-btn" id="executeCodeBtn" style="margin-top:18px;background:linear-gradient(90deg,#39ff14,#00ffea);color:#181c2f;font-weight:bold;font-size:1.2rem;padding:12px 48px;border-radius:32px;box-shadow:0 0 16px #39ff14;">RUN CODE</button>
        </div>
    </div>

    <!-- Success Flash -->
    <div class="success-flash" id="successFlash"></div>

    <script>
        // Game state
        let gameState = {
            arrivedAtNASA: false,
            codingStarted: false,
            codeComplete: false,
            selectedInput: null,
            correctAnswers: {
                input1: 'second',
                input2: 'range(1, 6)',
                input3: 'print',
                input4: 'second',
                input5: 'second',
                input6: '5'
            },
            userAnswers: {}
        };

        // DOM elements
        const dialogueBox = document.getElementById('dialogueBox');
        const dialogueText = document.getElementById('dialogueText');
        const dialogueButtons = document.getElementById('dialogueButtons');
        const codingInterface = document.getElementById('codingInterface');
        const executeCodeBtn = document.getElementById('executeCodeBtn');
        const trajectoryStatus = document.getElementById('trajectoryStatus');
        const trajectoryLine = document.getElementById('trajectoryLine');
        const spacecraftIcon = document.getElementById('spacecraftIcon');
        const successFlash = document.getElementById('successFlash');
        const timeTransition = document.getElementById('timeTransition');
        const starsContainer = document.getElementById('stars');

        // Create stars for transition
        for (let i = 0; i < 100; i++) {
            const star = document.createElement('div');
            star.className = 'star';
            star.style.left = Math.random() * 100 + '%';
            star.style.top = Math.random() * 100 + '%';
            star.style.animationDelay = Math.random() * 2 + 's';
            starsContainer.appendChild(star);
        }

        function initializeRepairBoxes() {
            const repairPieces = document.querySelectorAll('.repair-piece');
            repairPieces.forEach(piece => {
                piece.addEventListener('click', () => {
                    // Only navigate if the piece is active (completed)
                    if (piece.classList.contains('active')) {
                        const scene = piece.getAttribute('data-scene');
                        if (scene) {
                            window.location.href = scene;
                        }
                    }
                });
            });
        }

        // Initialize click handlers for all repair boxes
        initializeRepairBoxes();

        function getUserFromLocalStorage() {
            const userStr = localStorage.getItem('user');
            if (userStr) {
                try {
                    return JSON.parse(userStr);
                } catch (e) {
                    console.error('Error parsing user from localStorage:', e);
                    return null;
                }
            }
            return null;
        }

        // Load user progress and update repair boxes
        async function loadUserProgress() {
            try {
                const user = getUserFromLocalStorage();
                if (!user || !user.id) {
                    console.warn('âš ï¸ No user found in localStorage - skipping progress load');
                    return;
                }

                console.log('ðŸ“Š Loading progress for user:', user.id);
                const token = localStorage.getItem('token');
                const response = await fetch(`http://localhost:3001/api/progress/${user.id}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const progressData = await response.json();
                    console.log('ðŸ“¦ Progress data received:', progressData);

                    let activatedCount = 0;
                    progressData.forEach(level => {
                        if (level.completed) {
                            const piece = document.getElementById(`piece${level.level_id}`);
                            if (piece) {
                                if (!piece.classList.contains('active')) {
                                    piece.classList.add('active');
                                    activatedCount++;
                                    console.log(`âœ… Activated piece ${level.level_id}`);
                                } else {
                                    console.log(`â„¹ï¸ Piece ${level.level_id} already active`);
                                }
                            } else {
                                console.error(`âŒ Piece element not found: piece${level.level_id}`);
                            }
                        }
                    });
                    console.log(`âœ… Progress loaded: ${progressData.length} levels completed, ${activatedCount} pieces activated`);
                } else {
                    console.error('âŒ Failed to load progress:', response.status, response.statusText);
                }
            } catch (error) {
                console.error('âŒ Error loading user progress:', error);
            }
        }

        // Ensure DOM is loaded before initializing progress
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', loadUserProgress);
        } else {
            loadUserProgress();
        }

        // Initialize
        setTimeout(() => {
            timeTransition.style.display = 'none';
            introduceKatherine();
        }, 3500);

        function introduceKatherine() {
            gameState.arrivedAtNASA = true;
            setTimeout(() => {
                showDialogue(
                    "Welcome to the launch center!\n\nToday we're preparing a historic mission: the first woman in space.\nValentina's spacecraft is almost ready, but there's a problem with the countdown computer.\n\nThe program that counts down to launch is broken, and without it the rocket can't take off safely.\n\nWe need a simple piece of code that can count and check when it's time for liftoff.\n\nCan you help us fix the countdown?",
                    [{ text: "I'm ready to help!", action: explainMission }]
                );
            }, 500);
        }

        function explainMission() {
            showDialogue(
                "Excellent! We'll keep the code small and clear.\n\nWe'll use three ideas you already know:\n\n print to show the countdown on the screen\n\n a for loop to repeat the countdown steps\n\n an if statement to decide when to shout LIFTOFF!",
                [{ text: "What's the plan?", action: startCoding }]
            );
        }

        function startCoding() {
            showDialogue(
                "Our plan:\n\n Count from 1 to 5\n\n Print each step as: T-minus <number>\n\n When we reach 5, also print \"LIFTOFF, VALENTINA!\"\n\nFill in the missing pieces of the code to make the countdown work.",
                [{ text: "Let's write the code!", action: openCodingInterface }]
            );
        }

        function openCodingInterface() {
            hideDialogue();
            gameState.codingStarted = true;
            codingInterface.classList.add('active');
            initializeCodingInterface();
        }

        function initializeCodingInterface() {
            const inputs = document.querySelectorAll('.code-input');
            const optionChips = document.querySelectorAll('.option-chip');

            // Add click handlers to inputs
            inputs.forEach(input => {
                input.addEventListener('click', function() {
                    // Remove previous selection
                    inputs.forEach(i => i.style.outline = 'none');
                    // Highlight selected
                    this.style.outline = '2px solid #00aaff';
                    gameState.selectedInput = this;
                });

                // Allow typing
                    input.addEventListener('input', function() {
                        checkInput(this);
                    });
            });

            // Add click handlers to option chips
            optionChips.forEach(chip => {
                chip.addEventListener('click', function() {
                    if (!gameState.selectedInput) {
                        alert('Please click on a blank (???) in the code first!');
                        return;
                    }

                    const value = this.getAttribute('data-value');
                    // Put the option value into the selected blank
                    gameState.selectedInput.value = value;
                    checkInput(gameState.selectedInput);
                    // update visual indicators for chips used in blanks
                    updateChipUsage();

                    // Clear selection UI
                    gameState.selectedInput.style.outline = 'none';
                    gameState.selectedInput = null;
                });
            });

            executeCodeBtn.addEventListener('click', executeCode);

            // initial chip usage state
            updateChipUsage();
        }

        function checkInput(input) {
            const inputId = input.id;
            const userValue = input.value.trim();
            const correctValue = gameState.correctAnswers[inputId];

            gameState.userAnswers[inputId] = userValue;

            if (userValue === correctValue) {
                input.classList.remove('incorrect');
                input.classList.add('correct');
            } else if (userValue !== '') {
                input.classList.remove('correct');
                input.classList.add('incorrect');
            } else {
                input.classList.remove('correct', 'incorrect');
            }

            // Check if all inputs are filled
            checkAllInputs();

            // update chip visuals every time an input changes
            updateChipUsage();
        }

        // Update chips to visually indicate which options are currently used
        function updateChipUsage() {
            const chips = document.querySelectorAll('.option-chip');
            const inputs = document.querySelectorAll('.code-input');
            // gather non-empty values from inputs
            const usedValues = new Set(Array.from(inputs).map(i => i.value.trim()).filter(v => v !== ''));

            chips.forEach(chip => {
                const v = chip.getAttribute('data-value');
                if (usedValues.has(v)) {
                    chip.classList.add('in-use');
                } else {
                    chip.classList.remove('in-use');
                }
            });
        }

        function checkAllInputs() {
            const allFilled = Object.keys(gameState.correctAnswers).every(key => {
                return gameState.userAnswers[key] && gameState.userAnswers[key].trim() !== '';
            });

            executeCodeBtn.disabled = !allFilled;
        }

        function executeCode() {
            // Check if all answers are correct
            let allCorrect = true;
            let incorrectCount = 0;

            Object.keys(gameState.correctAnswers).forEach(key => {
                const input = document.getElementById(key);
                const userValue = gameState.userAnswers[key];
                const correctValue = gameState.correctAnswers[key];

                if (userValue !== correctValue) {
                    allCorrect = false;
                    incorrectCount++;
                    input.classList.add('incorrect');
                    input.classList.remove('correct');
                }
            });

            if (allCorrect) {
                codeSuccess();
            } else {
                codeFailed(incorrectCount);
            }
        }

        function codeFailed(count) {
            alert(`Code Error!\n\n${count} line(s) contain incorrect values.\nCheck the red-highlighted fields and try again.\n\nHint: Review Katherine's equations on the blackboard!`);
        }

        async function codeSuccess() {
            gameState.codeComplete = true;

            // Simulate code execution
            const codeEditor = document.getElementById('codeEditor');
            codeEditor.style.animation = 'pulse 1s ease-in-out';

            setTimeout(async () => {
                // Update trajectory status
                trajectoryStatus.textContent = 'ON COURSE âœ“';
                trajectoryStatus.style.color = '#00ff00';
                trajectoryLine.classList.add('corrected');
                spacecraftIcon.classList.add('corrected');

                // Flash effect
                successFlash.classList.add('active');
                setTimeout(() => {
                    successFlash.classList.remove('active');
                }, 1500);

                // Save progress to backend
                try {
                    const user = getUserFromLocalStorage();
                    if (user && user.id) {
                        await updateUserProgress(user.id, 5, 100, true);
                        console.log('âœ… Level 5 Progress Saved');
                    }
                } catch (error) {
                    console.error('Error saving progress:', error);
                }

                // Repair time machine and continue
                setTimeout(() => {
                    document.getElementById('piece5').classList.add('active');

                    setTimeout(() => {
                        codingInterface.classList.remove('active');
                        completeScene();
                    }, 1500);
                }, 1000);
            }, 1000);
        }

        function completeScene() {
            showDialogue(
                "Perfect! Your code works beautifully. The countdown computer is fixed and Valentina's rocket is ready for launch. You've mastered the basics - loops to repeat actions, print to show output, and conditionals to make decisions. That's all you need to make powerful programs!",
                [{ text: "Thank you for teaching me!", action: katherineWisdom }]
            );
        }

        function katherineWisdom() {
            showDialogue(
                "Remember - behind every successful space mission is thousands of lines of code, written by people who understand these simple building blocks. With loops, conditionals, and functions, you can build anything. Your time machine's countdown system is now repaired. Continue your journey with confidence!",
                [{ text: "Continue Journey â†’", action: goToNextScene }]
            );
        }

        function goToNextScene() {
            // Save progress as 5/8 (63%) before navigating
            try {
                const completedLevels = 5;
                const totalLevels = 8;
                const percent = Math.round((completedLevels / totalLevels) * 100);
                localStorage.setItem('gameProgressPercent', String(percent));
                localStorage.setItem('gameProgressLabel', `${completedLevels}/${totalLevels}`);
            } catch (e) {
                // ignore storage errors
            }

            // Mark HUD box active for level 5
            const piece5El = document.getElementById('piece5');
            if (piece5El) piece5El.classList.add('active');

            // Navigate to next scene
            window.location.href = 'SceneSix.html';
        }

        // Dialogue system
        function showDialogue(text, buttons) {
            dialogueText.textContent = text;
            dialogueButtons.innerHTML = '';
            
            buttons.forEach(btn => {
                const button = document.createElement('button');
                button.className = 'dialogue-btn';
                button.textContent = btn.text;
                button.onclick = btn.action;
                dialogueButtons.appendChild(button);
            });
            
            // dialogue appears anchored at the lower part of the screen (no dynamic reposition)

            dialogueBox.classList.add('active');
        }

        function hideDialogue() {
            dialogueBox.classList.remove('active');
            // clear inline top/bottom positioning so dialog will return to default on next show
            dialogueBox.style.top = '';
            dialogueBox.style.bottom = '';
        }


        // dialogue is bottom-anchored and uses default transition; motion API removed

        // Add pulse animation for code success
        const style = document.createElement('style');
        style.textContent = `
            @keyframes pulse {
                0%, 100% { transform: scale(1); }
                50% { transform: scale(1.02); }
            }
        `;
        document.head.appendChild(style);

        // Helper function to update user progress
        async function updateUserProgress(userId, levelId, score, completed) {
            const API_BASE_URL = 'http://localhost:3001';
            const token = localStorage.getItem('token');

            const response = await fetch(`${API_BASE_URL}/api/progress/${userId}/level/${levelId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({ score, completed })
            });

            if (!response.ok) {
                throw new Error('Failed to update progress');
            }

            return response.json();
        }

        // Logout function
        function handleLogout() {
            // Clear localStorage
            localStorage.removeItem('token');
            localStorage.removeItem('userId');
            localStorage.removeItem('username');
            
            // Redirect to start screen
            window.location.href = '../StartScreen.html';
        }
    </script>
</body>
</html>