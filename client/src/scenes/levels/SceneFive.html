<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scene 8: Katherine Johnson - SHE<Codes/></title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Courier New', monospace;
            background: #0a0a0a;
            overflow: hidden;
            height: 100vh;
        }

        /* Game Container */
        #game-container {
            position: relative;
            width: 100vw;
            height: 100vh;
            background: url('images/nasa-control-room.jpg') center center no-repeat;
            background-size: cover;
            background-color: #1a1a2a;
        }

        /* Time transition - space themed */
        .time-transition {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, #000428 0%, #004e92 50%, #000000 100%);
            z-index: 3000;
            animation: spaceTravel 3s ease-out forwards;
            pointer-events: none;
        }

        @keyframes spaceTravel {
            0% { opacity: 1; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.2); }
            100% { opacity: 0; transform: scale(1.5); }
        }

        .stars {
            position: absolute;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }

        .star {
            position: absolute;
            width: 2px;
            height: 2px;
            background: white;
            border-radius: 50%;
            animation: twinkle 2s ease-in-out infinite;
        }

        @keyframes twinkle {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 1; }
        }

        /* NASA Control Room Elements */
        .control-panel {
            position: absolute;
            top: 15%;
            left: 8%;
            width: 200px;
            height: 150px;
            background: linear-gradient(135deg, #2a2a3a 0%, #1a1a2a 100%);
            border: 3px solid #3a3a4a;
            border-radius: 5px;
        }

        .panel-lights {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            padding: 15px;
        }

        .indicator-light {
            width: 100%;
            height: 20px;
            border-radius: 3px;
            animation: blink 2s ease-in-out infinite;
        }

        .light-red { background: #ff0000; animation-delay: 0s; }
        .light-green { background: #00ff00; animation-delay: 0.5s; }
        .light-yellow { background: #ffff00; animation-delay: 1s; }
        .light-blue { background: #0088ff; animation-delay: 1.5s; }

        @keyframes blink {
            0%, 100% { opacity: 0.3; box-shadow: none; }
            50% { opacity: 1; box-shadow: 0 0 10px currentColor; }
        }

        .large-monitor {
            position: absolute;
            top: 12%;
            right: 10%;
            width: 250px;
            height: 180px;
            background: #0a0a0a;
            border: 5px solid #3a3a4a;
            border-radius: 5px;
            overflow: hidden;
        }

        .monitor-display {
            width: 100%;
            height: 100%;
            background: linear-gradient(to bottom, #001a00 0%, #000a00 100%);
            color: #00ff00;
            font-size: 0.7rem;
            padding: 10px;
            line-height: 1.4;
        }

        .trajectory-line {
            position: absolute;
            width: 100%;
            height: 2px;
            background: #ff0000;
            top: 50%;
            animation: trajectoryShift 2s ease-in-out infinite;
        }

        @keyframes trajectoryShift {
            0%, 100% { transform: translateY(-10px); }
            50% { transform: translateY(10px); }
        }

        .trajectory-line.corrected {
            background: #00ff00;
            animation: none;
            transform: translateY(0);
        }

        /* Main Display - Blackboard */
        .blackboard-section {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 550px;
            height: 450px;
            z-index: 10;
        }

        .blackboard {
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #1a3a1a 0%, #0a2a0a 100%);
            border: 8px solid #654321;
            border-radius: 5px;
            position: relative;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.9);
        }

        .blackboard-content {
            padding: 30px;
            color: #ffffff;
            height: 100%;
            overflow-y: auto;
        }

        .equation-title {
            font-size: 1.3rem;
            color: #ffff99;
            margin-bottom: 15px;
            text-align: center;
            text-decoration: underline;
        }

        .equation-display {
            background: rgba(0, 0, 0, 0.3);
            border: 2px solid #556b2f;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 20px;
            font-size: 1rem;
            line-height: 1.8;
            color: #ffffcc;
        }

        .hint-box {
            background: rgba(139, 69, 19, 0.3);
            border: 2px solid #8b4513;
            border-radius: 5px;
            padding: 12px;
            margin-top: 15px;
            font-size: 0.85rem;
            color: #ffd700;
        }

        .chalk-text {
            text-shadow: 1px 1px 2px rgba(255, 255, 255, 0.3);
        }

        /* Katherine Johnson Character */
        .katherine-character {
            position: absolute;
            top: 48%;
            left: 18%;
            transform: translateY(-50%);
            width: 185px;
            height: 260px;
            z-index: 5;
            background-image: url('../../assets/Characterblue.png');
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
        }

        :root {
            --dialog-duration: 0.18s; /* default: snappy */
            --dialog-ease: cubic-bezier(.2,.9,.2,1);
            --dialog-opacity-duration: 0.12s;
        }

        /* Player Character */
        .player {
            position: absolute;
            bottom: 30%;
            right: 20%;
            width: 80px;
            height: 120px;
            background: linear-gradient(to bottom, #667eea 0%, #4a5aa8 100%);
            border-radius: 25px 25px 10px 10px;
            z-index: 100;
            opacity: 0;
            animation: playerAppear 1s ease-out 3s forwards;
            background-image: url('../../assets/Characterpink.png');
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
        }

        @keyframes playerAppear {
            0% { opacity: 0; transform: scale(0.5) translateY(-50px); }
            50% { opacity: 1; transform: scale(1.2) translateY(-10px); }
            100% { opacity: 1; transform: scale(1) translateY(0); }
        }

        .player::before {
            display: none;
        }

        /* Dialogue Box */
        .dialogue-box {
            position: absolute;
            /* anchored to lower part of the screen so it doesn't block the blackboard */
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%) translateY(-6px);
            width: min(72%, 720px);
            max-width: 720px;
            background: rgba(10, 10, 26, 0.95);
            border: 4px solid #0088ff;
            border-radius: 15px;
            padding: 16px 18px;
            color: #ffffff;
            display: none;
            z-index: 1000;
            opacity: 0;
            transition: transform 0.18s cubic-bezier(.2,.9,.2,1), opacity 0.12s cubic-bezier(.2,.9,.2,1);
            box-shadow: 0 0 30px rgba(0, 136, 255, 0.3);
        }

        .dialogue-box.active {
            display: block;
            /* visible state - animate to neutral position */
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }

        .dialogue-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #0088ff;
        }

        .dialogue-portrait {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #4a5a8a 0%, #2a3a5a 100%);
            border-radius: 50%;
            border: 3px solid #0088ff;
            margin-right: 15px;
        }

        .dialogue-name {
            font-size: 1.12rem;
            font-weight: bold;
            color: #0088ff;
        }

        .dialogue-text {
            /* slightly smaller text so the dialogue box takes up less screen height */
            font-size: 0.95rem;
            line-height: 1.8;
            margin-bottom: 15px;
        }

        /* responsive: keep dialog readable but compact on small screens */
        @media (max-width: 720px) {
            .dialogue-box { width: 92%; max-width: 92%; padding: 12px 14px; }
            .dialogue-text { font-size: 0.88rem; line-height: 1.6; }
            .dialogue-name { font-size: 1rem; }
            .dialogue-buttons { margin-top: 12px; gap: 10px; }
            .dialogue-btn { padding: 10px 22px; font-size: 0.95rem; }
        }

        .dialogue-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
        }

        /* small repositioning helper - when repositioning, briefly offset and animate back */
        /* repositioning helper removed â€” dialogues always anchored to bottom */

        .dialogue-btn {
            background: linear-gradient(135deg, #0088ff 0%, #0055cc 100%);
            border: 2px solid #00aaff;
            color: #ffffff;
            padding: 12px 30px;
            font-size: 1rem;
            font-weight: bold;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Courier New', monospace;
        }

        .dialogue-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 136, 255, 0.5);
            background: linear-gradient(135deg, #0099ff 0%, #0066dd 100%);
        }

        /* Coding Interface */
        .coding-interface {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.92);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .coding-interface.active {
            display: flex;
        }

        .code-panel {
            background: linear-gradient(135deg, #1a1a2a 0%, #0a0a1a 100%);
            border: 5px solid #0088ff;
            border-radius: 20px;
            padding: 30px;
            max-width: 900px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 136, 255, 0.4);
        }

        .code-title {
            font-size: 1.8rem;
            color: #0088ff;
            text-align: center;
            margin-bottom: 10px;
            text-shadow: 0 0 10px rgba(0, 136, 255, 0.5);
        }

        .code-instruction {
            color: #ffffff;
            text-align: center;
            font-size: 1.1rem;
            margin-bottom: 30px;
            line-height: 1.6;
        }

        .code-editor {
            background: #0a0a1a;
            border: 3px solid #2a2a3a;
            border-radius: 10px;
            padding: 25px;
            font-family: 'Courier New', monospace;
            font-size: 1rem;
            line-height: 1.8;
            color: #00ff00;
            margin-bottom: 20px;
        }

        .code-line {
            margin: 8px 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .line-number {
            color: #666;
            min-width: 30px;
            text-align: right;
            user-select: none;
        }

        .code-text {
            color: #00ff00;
        }

        .keyword {
            color: #ff6b9d;
            font-weight: bold;
        }

        .function-name {
            color: #4ecdc4;
        }

        .variable {
            color: #ffd700;
        }

        .comment {
            color: #888;
            font-style: italic;
        }

        .code-input {
            background: #1a1a2a;
            border: 2px solid #0088ff;
            border-radius: 5px;
            padding: 4px 8px;
            color: #ffd700;
            font-family: 'Courier New', monospace;
            font-size: 1rem;
            min-width: 100px;
            outline: none;
            transition: all 0.3s ease;
        }

        .code-input:focus {
            border-color: #00aaff;
            box-shadow: 0 0 10px rgba(0, 136, 255, 0.3);
        }

        .code-input.correct {
            border-color: #00ff00;
            background: rgba(0, 255, 0, 0.1);
        }

        .code-input.incorrect {
            border-color: #ff0000;
            background: rgba(255, 0, 0, 0.1);
            animation: shake 0.3s;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        .available-options {
            background: rgba(42, 42, 58, 0.6);
            border: 2px solid #2a2a3a;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .options-title {
            color: #0088ff;
            font-size: 1rem;
            margin-bottom: 10px;
            text-align: center;
        }

        .options-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
        }

        .option-chip {
            background: #2a2a3a;
            border: 2px solid #3a3a4a;
            border-radius: 15px;
            padding: 6px 15px;
            color: #00aaff;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
            user-select: none;
        }

        .option-chip:hover {
            background: #3a3a4a;
            border-color: #0088ff;
            transform: scale(1.05);
        }

        .option-chip.used {
            opacity: 0.3;
            cursor: default;
            pointer-events: none;
        }

        /* Visual indicator (soft) for chips that are currently used in any blank */
        .option-chip.in-use {
            box-shadow: 0 6px 18px rgba(0,170,255,0.25) inset, 0 8px 25px rgba(0,170,255,0.12);
            border-color: #00aaff;
            transform: translateY(-3px);
            transition: transform .12s ease, box-shadow .12s ease, border-color .12s ease;
        }

        .execute-code-btn {
            display: block;
            margin: 20px auto 0;
            background: linear-gradient(135deg, #00ff00 0%, #00aa00 100%);
            border: 3px solid #00ff00;
            color: #000000;
            padding: 15px 50px;
            font-size: 1.3rem;
            font-weight: bold;
            border-radius: 30px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Courier New', monospace;
            text-transform: uppercase;
        }

        .execute-code-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 25px rgba(0, 255, 0, 0.6);
        }

        .execute-code-btn:disabled {
            background: #333;
            border-color: #555;
            color: #666;
            cursor: not-allowed;
            opacity: 0.5;
        }

        /* Success Flash */
        .success-flash {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, rgba(0, 136, 255, 0.8) 0%, transparent 70%);
            opacity: 0;
            pointer-events: none;
            z-index: 2500;
        }

        .success-flash.active {
            animation: flashSuccess 1.5s ease-out;
        }

        @keyframes flashSuccess {
            0%, 100% { opacity: 0; }
            50% { opacity: 1; }
        }

        /* HUD */
        .hud {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(10, 10, 26, 0.9);
            border: 3px solid #0088ff;
            border-radius: 10px;
            padding: 15px;
            z-index: 1500;
        }

        .hud-title {
            color: #0088ff;
            font-size: 0.9rem;
            margin-bottom: 10px;
            text-align: center;
        }

        .repair-progress {
            display: flex;
            gap: 5px;
        }

        .repair-piece {
            width: 30px;
            height: 30px;
            border: 2px solid #2a2a3a;
            border-radius: 5px;
            background: #0a0a1a;
            transition: all 0.5s ease;
        }

        .repair-piece.active {
            background: linear-gradient(135deg, #0088ff 0%, #0055cc 100%);
            box-shadow: 0 0 15px rgba(0, 136, 255, 0.8);
            animation: piecePulse 1s ease-out;
            cursor: pointer;
        }

        .repair-piece.active:hover {
            transform: scale(1.15);
            box-shadow: 0 0 25px rgba(0, 136, 255, 1);
            border-color: #00aaff;
        }

        @keyframes piecePulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2); }
        }

        /* slideUp keyframes removed â€” dialog now uses transform+opacity transitions */

        /* Spacecraft visualization */
        .spacecraft-viz {
            position: absolute;
            top: 5px;
            left: 5px;
            right: 5px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .spacecraft-icon {
            font-size: 2rem;
            position: absolute;
            left: 10%;
            animation: driftOff 3s ease-in-out infinite;
        }

        @keyframes driftOff {
            0%, 100% { transform: translateY(-5px); }
            50% { transform: translateY(5px); }
        }

        .spacecraft-icon.corrected {
            animation: steadyFlight 1s ease-in-out infinite;
            left: 50%;
        }

        @keyframes steadyFlight {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-2px); }
        }
    </style>
</head>
<body>
    <div id="game-container">
        <!-- Time transition with stars -->
        <div class="time-transition" id="timeTransition">
            <div class="stars" id="stars"></div>
        </div>

        <!-- NASA Control Room Elements -->
        <div class="control-panel">
            <div class="panel-lights">
                <div class="indicator-light light-red"></div>
                <div class="indicator-light light-green"></div>
                <div class="indicator-light light-yellow"></div>
                <div class="indicator-light light-blue"></div>
                <div class="indicator-light light-green"></div>
                <div class="indicator-light light-red"></div>
                <div class="indicator-light light-blue"></div>
                <div class="indicator-light light-yellow"></div>
            </div>
        </div>

        <div class="large-monitor">
            <div class="monitor-display">
                <div class="spacecraft-viz">
                    <span class="spacecraft-icon" id="spacecraftIcon">ðŸš€</span>
                </div>
                TRAJECTORY STATUS:<br>
                <span id="trajectoryStatus" style="color: #ff0000;">OFF COURSE</span><br>
                <div class="trajectory-line" id="trajectoryLine"></div>
                <br>
                CORRECTION REQUIRED<br>
                AWAITING CALCULATIONS...
            </div>
        </div>

        <!-- Blackboard Section -->
        <div class="blackboard-section">
            <div class="blackboard">
                <div class="blackboard-content chalk-text">
                    <div class="equation-title">Trajectory Correction Formula</div>
                    <div class="equation-display">
                        <strong>Given:</strong><br>
                        â€¢ Current velocity: v = 7800 m/s<br>
                        â€¢ Target angle: Î¸ = 45Â°<br>
                        â€¢ Time step: Î”t = 1 second<br>
                        â€¢ Iterations: n = 10<br><br>
                        <strong>Calculate:</strong><br>
                        x = v Ã— cos(Î¸) Ã— t<br>
                        y = v Ã— sin(Î¸) Ã— t - 0.5 gtÂ²<br>
                    </div>
                    <div class="hint-box">
                        ðŸ’¡ <strong>Katherine's Note:</strong><br>
                        "Precision matters! We must loop through each time step and calculate the position. Use the loop variable 'i', multiply velocity by time, and call the print function to output results."
                    </div>
                </div>
            </div>
        </div>

        <!-- Katherine Johnson Character -->
        <div class="katherine-character"></div>

        <!-- Player Character -->
        <div class="player"></div>

        <!-- Dialogue Box -->
        <div class="dialogue-box" id="dialogueBox">
            <div class="dialogue-header">
                <div class="dialogue-portrait"></div>
                <div class="dialogue-name">Katherine Johnson</div>
            </div>
            <div class="dialogue-text" id="dialogueText"></div>
            <div class="dialogue-buttons" id="dialogueButtons"></div>
        </div>

        <!-- HUD -->
        <div class="hud">
            <div class="hud-title">Time Machine Repair</div>
            <div class="repair-progress">
                <div class="repair-piece" id="piece1" data-scene="SceneOne.html"></div>
                <div class="repair-piece" id="piece2" data-scene="SceneTwo.html"></div>
                <div class="repair-piece" id="piece3" data-scene="SceneThree.html"></div>
                <div class="repair-piece" id="piece4" data-scene="SceneFour.html"></div>
                <div class="repair-piece" id="piece5" data-scene="SceneFive.html"></div>
                <div class="repair-piece" id="piece6" data-scene="SceneSix.html"></div>
                <div class="repair-piece" id="piece7" data-scene="SceneSeven.html"></div>
                <div class="repair-piece" id="piece8" data-scene="SceneEight.html"></div>
            </div>
        </div>
    </div>

    <!-- Coding Interface -->
    <div class="coding-interface" id="codingInterface">
        <div class="code-panel">
            <h2 class="code-title">TRAJECTORY CALCULATION CODE</h2>
            <p class="code-instruction">
                Complete the missing parts of the code to calculate the spacecraft's corrected trajectory.<br>
                Fill in the blanks with the correct variable names, loop conditions, and function calls.
            </p>

            <div class="available-options">
                <div class="options-title">Available Options (click to use):</div>
                <div class="options-list">
                    <div class="option-chip" data-value="velocity">velocity</div>
                    <div class="option-chip" data-value="angle">angle</div>
                    <div class="option-chip" data-value="i">i</div>
                    <div class="option-chip" data-value="range">range</div>
                    <div class="option-chip" data-value="10">10</div>
                    <div class="option-chip" data-value="print">print</div>
                    <div class="option-chip" data-value="calculate_trajectory">calculate_trajectory</div>
                </div>
            </div>

            <div class="code-editor" id="codeEditor">
                <div class="code-line">
                    <span class="line-number">1</span>
                    <span class="code-text"><span class="keyword">def</span> <span class="function-name">calculate_trajectory</span>(<input class="code-input" id="input1" data-answer="velocity" placeholder="???">, <input class="code-input" id="input2" data-answer="angle" placeholder="???">):</span>
                </div>
                <div class="code-line">
                    <span class="line-number">2</span>
                    <span class="code-text">    <span class="comment"># Calculate trajectory over time</span></span>
                </div>
                <div class="code-line">
                    <span class="line-number">3</span>
                    <span class="code-text">    <span class="keyword">for</span> <input class="code-input" id="input3" data-answer="i" style="width: 60px;" placeholder="?"> <span class="keyword">in</span> <input class="code-input" id="input4" data-answer="range" placeholder="???">(</span><input class="code-input" id="input5" data-answer="10" style="width: 60px;" placeholder="?"><span class="code-text">):</span>
                </div>
                <div class="code-line">
                    <span class="line-number">4</span>
                    <span class="code-text">        <span class="variable">t</span> = <input class="code-input" id="input6" data-answer="i" style="width: 60px;" placeholder="?"> * <span class="variable">delta_t</span></span>
                </div>
                <div class="code-line">
                    <span class="line-number">5</span>
                    <span class="code-text">        <span class="variable">x</span> = <input class="code-input" id="input7" data-answer="velocity" placeholder="???"> * <span class="function-name">cos</span>(<input class="code-input" id="input8" data-answer="angle" placeholder="???">) * <span class="variable">t</span></span>
                </div>
                <div class="code-line">
                    <span class="line-number">6</span>
                    <span class="code-text">        <span class="variable">y</span> = <span class="variable">velocity</span> * <span class="function-name">sin</span>(<span class="variable">angle</span>) * <span class="variable">t</span></span>
                </div>
                <div class="code-line">
                    <span class="line-number">7</span>
                    <span class="code-text">        <input class="code-input" id="input9" data-answer="print" placeholder="???">(f<span class="variable">"Time: {t}s, Position: ({x}, {y})"</span>)</span>
                </div>
                <div class="code-line">
                    <span class="line-number">8</span>
                    <span class="code-text">    <span class="keyword">return</span> <span class="variable">True</span></span>
                </div>
                <div class="code-line">
                    <span class="line-number">9</span>
                    <span class="code-text"></span>
                </div>
                <div class="code-line">
                    <span class="line-number">10</span>
                    <span class="code-text"><span class="comment"># Execute trajectory correction</span></span>
                </div>
                <div class="code-line">
                    <span class="line-number">11</span>
                    <span class="code-text"><input class="code-input" id="input10" data-answer="calculate_trajectory" placeholder="???">(velocity=7800, angle=45)</span>
                </div>
            </div>

            <button class="execute-code-btn" id="executeCodeBtn">Run Calculation</button>
        </div>
    </div>

    <!-- Success Flash -->
    <div class="success-flash" id="successFlash"></div>

    <script>
        // Game state
        let gameState = {
            arrivedAtNASA: false,
            metKatherine: false,
            codingStarted: false,
            codeComplete: false,
            selectedInput: null,
            correctAnswers: {
                input1: 'velocity',
                input2: 'angle',
                input3: 'i',
                input4: 'range',
                input5: '10',
                input6: 'i',
                input7: 'velocity',
                input8: 'angle',
                input9: 'print',
                input10: 'calculate_trajectory'
            },
            userAnswers: {}
        };

        // DOM elements
        const dialogueBox = document.getElementById('dialogueBox');
        const dialogueText = document.getElementById('dialogueText');
        const dialogueButtons = document.getElementById('dialogueButtons');
        const codingInterface = document.getElementById('codingInterface');
        const executeCodeBtn = document.getElementById('executeCodeBtn');
        const trajectoryStatus = document.getElementById('trajectoryStatus');
        const trajectoryLine = document.getElementById('trajectoryLine');
        const spacecraftIcon = document.getElementById('spacecraftIcon');
        const successFlash = document.getElementById('successFlash');
        const timeTransition = document.getElementById('timeTransition');
        const starsContainer = document.getElementById('stars');

        // Create stars for transition
        for (let i = 0; i < 100; i++) {
            const star = document.createElement('div');
            star.className = 'star';
            star.style.left = Math.random() * 100 + '%';
            star.style.top = Math.random() * 100 + '%';
            star.style.animationDelay = Math.random() * 2 + 's';
            starsContainer.appendChild(star);
        }

        function initializeRepairBoxes() {
            const repairPieces = document.querySelectorAll('.repair-piece');
            repairPieces.forEach(piece => {
                piece.addEventListener('click', () => {
                    // Only navigate if the piece is active (completed)
                    if (piece.classList.contains('active')) {
                        const scene = piece.getAttribute('data-scene');
                        if (scene) {
                            window.location.href = scene;
                        }
                    }
                });
            });
        }

        // Initialize click handlers for all repair boxes
        initializeRepairBoxes();

        function getUserFromLocalStorage() {
            const userStr = localStorage.getItem('user');
            if (userStr) {
                try {
                    return JSON.parse(userStr);
                } catch (e) {
                    console.error('Error parsing user from localStorage:', e);
                    return null;
                }
            }
            return null;
        }

        // Load user progress and update repair boxes
        async function loadUserProgress() {
            try {
                const user = getUserFromLocalStorage();
                if (!user || !user.id) {
                    console.log('No user found in localStorage');
                    return;
                }

                // Fetch user profile to get current progress
                const response = await fetch(`http://localhost:3001/api/users/${user.id}`, {
                    headers: {
                        'Authorization': `Bearer ${user.token}`
                    }
                });

                if (response.ok) {
                    const userData = await response.json();
                    const progress = userData.progress || 0;
                    
                    // Calculate how many levels completed based on progress (12.5% per level)
                    const completedLevels = Math.floor(progress / 12.5);
                    
                    // Since we're on Scene 5, we know the player must have passed scenes 1-4
                    // Show whichever is higher: saved progress or current scene - 1
                    const currentScene = 5;
                    const boxesToActivate = Math.max(completedLevels, currentScene - 1);
                    
                    console.log(`ðŸ“Š Scene 5 - User progress: ${progress}%`);
                    console.log(`ðŸ“¦ Boxes to activate: ${boxesToActivate} (progress: ${completedLevels}, minimum for scene 5: ${currentScene - 1})`);
                    
                    // Activate repair boxes for all completed levels
                    // This allows players to click and revisit any completed level
                    for (let i = 1; i <= boxesToActivate; i++) {
                        const piece = document.getElementById(`piece${i}`);
                        if (piece) {
                            if (!piece.classList.contains('active')) {
                                piece.classList.add('active');
                                console.log(`âœ… Activated box ${i}`);
                            } else {
                                console.log(`â„¹ï¸ Box ${i} already active`);
                            }
                        } else {
                            console.error(`âŒ Box ${i} element not found`);
                        }
                    }
                    
                    console.log(`âœ… Loaded progress: ${progress}% - ${boxesToActivate} boxes activated`);
                }
            } catch (error) {
                console.error('Error loading user progress:', error);
            }
        }

        // Load progress when page loads
        loadUserProgress();

        // Initialize
        setTimeout(() => {
            timeTransition.style.display = 'none';
            introduceKatherine();
        }, 3500);

        function introduceKatherine() {
            gameState.arrivedAtNASA = true;
            setTimeout(() => {
                showDialogue(
                    "Welcome to the launch center!\n\nToday we're preparing a historic mission: the first woman in space.\nValentina's spacecraft is almost ready, but there's a problem with the countdown computer.\n\nThe program that counts down to launch is broken, and without it the rocket can't take off safely.\n\nWe need a simple piece of code that can count and check when it's time for liftoff.\n\nCan you help us fix the countdown?",
                    [{ text: "I'm ready to help!", action: explainMission }]
                );
            }, 500);
        }

        function explainMission() {
            showDialogue(
                "Excellent! We'll keep the code small and clear.\n\nWe'll use three ideas you already know:\n\nâ€¢ print to show the countdown on the screen\nâ€¢ a for loop to repeat the countdown steps\nâ€¢ an if statement to decide when to shout LIFTOFF!",
                [{ text: "What's the plan?", action: startCoding }]
            );
        }

        function startCoding() {
            showDialogue(
                "Our plan:\n\nâ€¢ Count from 1 to 5\nâ€¢ Print each step as: T-minus <number>\nâ€¢ When we reach 5, also print \"LIFTOFF, VALENTINA!\"\n\nFill in the missing pieces of the code to make the countdown work.",
                [{ text: "Let's write the code!", action: openCodingInterface }]
            );
        }

        function openCodingInterface() {
            hideDialogue();
            gameState.codingStarted = true;
            codingInterface.classList.add('active');
            initializeCodingInterface();
        }

        function initializeCodingInterface() {
            const inputs = document.querySelectorAll('.code-input');
            const optionChips = document.querySelectorAll('.option-chip');

            // Add click handlers to inputs
            inputs.forEach(input => {
                input.addEventListener('click', function() {
                    // Remove previous selection
                    inputs.forEach(i => i.style.outline = 'none');
                    // Highlight selected
                    this.style.outline = '2px solid #00aaff';
                    gameState.selectedInput = this;
                });

                // Allow typing
                    input.addEventListener('input', function() {
                        checkInput(this);
                    });
            });

            // Add click handlers to option chips
            optionChips.forEach(chip => {
                chip.addEventListener('click', function() {
                    if (!gameState.selectedInput) {
                        alert('Please click on a blank (???) in the code first!');
                        return;
                    }

                    const value = this.getAttribute('data-value');
                    // Put the option value into the selected blank
                    gameState.selectedInput.value = value;
                    checkInput(gameState.selectedInput);
                    // update visual indicators for chips used in blanks
                    updateChipUsage();

                    // Clear selection UI
                    gameState.selectedInput.style.outline = 'none';
                    gameState.selectedInput = null;
                });
            });

            executeCodeBtn.addEventListener('click', executeCode);

            // initial chip usage state
            updateChipUsage();
        }

        function checkInput(input) {
            const inputId = input.id;
            const userValue = input.value.trim();
            const correctValue = gameState.correctAnswers[inputId];

            gameState.userAnswers[inputId] = userValue;

            if (userValue === correctValue) {
                input.classList.remove('incorrect');
                input.classList.add('correct');
            } else if (userValue !== '') {
                input.classList.remove('correct');
                input.classList.add('incorrect');
            } else {
                input.classList.remove('correct', 'incorrect');
            }

            // Check if all inputs are filled
            checkAllInputs();

            // update chip visuals every time an input changes
            updateChipUsage();
        }

        // Update chips to visually indicate which options are currently used
        function updateChipUsage() {
            const chips = document.querySelectorAll('.option-chip');
            const inputs = document.querySelectorAll('.code-input');
            // gather non-empty values from inputs
            const usedValues = new Set(Array.from(inputs).map(i => i.value.trim()).filter(v => v !== ''));

            chips.forEach(chip => {
                const v = chip.getAttribute('data-value');
                if (usedValues.has(v)) {
                    chip.classList.add('in-use');
                } else {
                    chip.classList.remove('in-use');
                }
            });
        }

        function checkAllInputs() {
            const allFilled = Object.keys(gameState.correctAnswers).every(key => {
                return gameState.userAnswers[key] && gameState.userAnswers[key].trim() !== '';
            });

            executeCodeBtn.disabled = !allFilled;
        }

        function executeCode() {
            // Check if all answers are correct
            let allCorrect = true;
            let incorrectCount = 0;

            Object.keys(gameState.correctAnswers).forEach(key => {
                const input = document.getElementById(key);
                const userValue = gameState.userAnswers[key];
                const correctValue = gameState.correctAnswers[key];

                if (userValue !== correctValue) {
                    allCorrect = false;
                    incorrectCount++;
                    input.classList.add('incorrect');
                    input.classList.remove('correct');
                }
            });

            if (allCorrect) {
                codeSuccess();
            } else {
                codeFailed(incorrectCount);
            }
        }

        function codeFailed(count) {
            alert(`Code Error!\n\n${count} line(s) contain incorrect values.\nCheck the red-highlighted fields and try again.\n\nHint: Review Katherine's equations on the blackboard!`);
        }

        async function codeSuccess() {
            gameState.codeComplete = true;

            // Simulate code execution
            const codeEditor = document.getElementById('codeEditor');
            codeEditor.style.animation = 'pulse 1s ease-in-out';

            setTimeout(async () => {
                // Update trajectory status
                trajectoryStatus.textContent = 'ON COURSE âœ“';
                trajectoryStatus.style.color = '#00ff00';
                trajectoryLine.classList.add('corrected');
                spacecraftIcon.classList.add('corrected');

                // Flash effect
                successFlash.classList.add('active');
                setTimeout(() => {
                    successFlash.classList.remove('active');
                }, 1500);

                // Save progress to backend
                try {
                    const user = getUserFromLocalStorage();
                    if (user && user.id) {
                        await updateUserProgress(user.id, 5, 100, true);
                        console.log('âœ… Level 5 Progress Saved');
                    }
                } catch (error) {
                    console.error('Error saving progress:', error);
                }

                // Show success message
                setTimeout(() => {
                    alert('CODE EXECUTED SUCCESSFULLY!\n\nTrajectory corrected!\nSpacecraft is now on the optimal path!');

                    // Repair time machine
                    document.getElementById('piece5').classList.add('active');

                    setTimeout(() => {
                        codingInterface.classList.remove('active');
                        completeScene();
                    }, 1500);
                }, 1000);
            }, 1000);
        }

        function completeScene() {
            showDialogue(
                "Perfect! Your calculations were flawless. The spacecraft is back on course thanks to your precise coding. You understand something crucial - in programming, just like in space navigation, every variable matters, every loop must be exact, and every function must be called correctly.",
                [{ text: "Thank you for teaching me!", action: katherineWisdom }]
            );
        }

        function katherineWisdom() {
            showDialogue(
                "Remember - people said a woman couldn't do this kind of work, that calculations this complex were impossible for anyone but a machine. But I knew that with determination, precision, and understanding the mathematics, anything is possible. Your time machine's navigation system is now repaired. Continue your journey with confidence!",
                [{ text: "Continue Journey â†’", action: goToNextScene }]
            );
        }

        function goToNextScene() {
            
            alert("Outstanding work!\n\nNext: Scene 6 - Margaret Hamilton (1960s-70s)\n\nYou'll help Margaret debug the Apollo mission software with conditional statements and error handling!");
            // In actual implementation:
            window.location.href = 'SceneSix.html';
        }

        // Dialogue system
        function showDialogue(text, buttons) {
            dialogueText.textContent = text;
            dialogueButtons.innerHTML = '';
            
            buttons.forEach(btn => {
                const button = document.createElement('button');
                button.className = 'dialogue-btn';
                button.textContent = btn.text;
                button.onclick = btn.action;
                dialogueButtons.appendChild(button);
            });
            
            // dialogue appears anchored at the lower part of the screen (no dynamic reposition)

            dialogueBox.classList.add('active');
        }

        function hideDialogue() {
            dialogueBox.classList.remove('active');
            // clear inline top/bottom positioning so dialog will return to default on next show
            dialogueBox.style.top = '';
            dialogueBox.style.bottom = '';
        }


        // dialogue is bottom-anchored and uses default transition; motion API removed

        // Add pulse animation for code success
        const style = document.createElement('style');
        style.textContent = `
            @keyframes pulse {
                0%, 100% { transform: scale(1); }
                50% { transform: scale(1.02); }
            }
        `;
        document.head.appendChild(style);

        // Helper function to update user progress
        async function updateUserProgress(userId, levelId, score, completed) {
            const API_BASE_URL = 'http://localhost:3001';
            const token = localStorage.getItem('token');

            const response = await fetch(`${API_BASE_URL}/api/progress/${userId}/level/${levelId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({ score, completed })
            });

            if (!response.ok) {
                throw new Error('Failed to update progress');
            }

            return response.json();
        }
    </script>
</body>
</html>