<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scene 7: Hedy Lamarr - SHE<Codes/></title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Courier New', monospace;
            background: #0a0a0a;
            overflow: hidden;
            height: 100vh;
        }

        /* Game Container */
        #game-container {
            position: relative;
            width: 100vw;
            height: 100vh;
            background: url('images/hollywood-studio.jpg') center center no-repeat;
            background-size: cover;
            background-color: #1a1a1a;
        }

        /* Level Transition Screen */
        .level-transition {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #1a1a1a 0%, #2a1a3a 50%, #1a1a1a 100%);
            z-index: 4000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            animation: transitionFade 5s ease-out forwards;
        }

        @keyframes transitionFade {
            0% { opacity: 1; }
            70% { opacity: 1; }
            100% { opacity: 0; pointer-events: none; }
        }

        .transition-title {
            font-size: 3rem;
            color: #ffd700;
            text-shadow: 0 0 20px rgba(255, 215, 0, 0.8);
            margin-bottom: 30px;
            animation: titlePulse 2s ease-in-out infinite;
        }

        @keyframes titlePulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .transition-message {
            font-size: 1.5rem;
            color: #ffffff;
            text-align: center;
            max-width: 700px;
            line-height: 1.8;
            margin-bottom: 40px;
        }

        .achievements-earned {
            background: rgba(0, 0, 0, 0.7);
            border: 3px solid #ffd700;
            border-radius: 15px;
            padding: 30px 50px;
            margin-top: 20px;
        }

        .achievement {
            display: flex;
            align-items: center;
            gap: 15px;
            margin: 15px 0;
            font-size: 1.2rem;
            color: #00ff00;
        }

        .achievement-icon {
            font-size: 2rem;
        }

        /* Studio Setting - Hollywood Aesthetic */
        .studio-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at 50% 40%, transparent 20%, rgba(0, 0, 0, 0.7) 80%);
            pointer-events: none;
        }

        .spotlight {
            position: absolute;
            width: 400px;
            height: 400px;
            border-radius: 50%;
            background: radial-gradient(circle, rgba(255, 255, 200, 0.3) 0%, transparent 70%);
            pointer-events: none;
            animation: spotlightFlicker 3s ease-in-out infinite;
        }

        .spotlight-1 {
            top: 10%;
            left: 45%;
        }

        @keyframes spotlightFlicker {
            0%, 100% { opacity: 0.8; }
            50% { opacity: 1; }
        }

        .film-reel {
            position: absolute;
            width: 80px;
            height: 80px;
            border: 5px solid #8b7355;
            border-radius: 50%;
            background: #2a2a2a;
            top: 20%;
            right: 10%;
        }

        .reel-hole {
            position: absolute;
            width: 20px;
            height: 20px;
            background: #1a1a1a;
            border-radius: 50%;
        }

        .camera {
            position: absolute;
            bottom: 20%;
            right: 15%;
            width: 100px;
            height: 80px;
            background: #2a2a2a;
            border: 3px solid #4a4a4a;
            border-radius: 5px;
        }

        /* Workbench */
        .workbench {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 500px;
            height: 400px;
            z-index: 10;
        }

        .bench-surface {
            width: 100%;
            height: 100%;
            background: linear-gradient(to bottom, #6b5742 0%, #4a3829 100%);
            border: 5px solid #8b7355;
            border-radius: 10px;
            position: relative;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.9);
        }

        .radio-receiver {
            position: absolute;
            top: 30px;
            left: 50%;
            transform: translateX(-50%);
            width: 250px;
            height: 180px;
            background: linear-gradient(135deg, #3a3a3a 0%, #1a1a1a 100%);
            border: 4px solid #5a5a5a;
            border-radius: 10px;
            box-shadow: inset 0 0 20px rgba(0, 0, 0, 0.8);
        }

        .radio-dial {
            position: absolute;
            top: 20px;
            left: 20px;
            width: 60px;
            height: 60px;
            background: #2a2a2a;
            border: 3px solid #4a4a4a;
            border-radius: 50%;
        }

        .radio-screen {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 130px;
            height: 60px;
            background: #0a0a0a;
            border: 2px solid #2a2a2a;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #00ff00;
            font-size: 0.8rem;
        }

        .frequency-display {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            height: 70px;
            background: #0a0a0a;
            border: 3px solid #ffd700;
            border-radius: 5px;
        }

        .signal-wave {
            position: absolute;
            bottom: 10px;
            left: 0;
            width: 100%;
            height: 50px;
            display: flex;
            align-items: flex-end;
            justify-content: space-around;
            padding: 5px;
        }

        .signal-bar {
            width: 8%;
            background: linear-gradient(to top, #00ff00 0%, #00aa00 100%);
            border-radius: 3px 3px 0 0;
            opacity: 0;
            transition: all 0.3s ease;
        }

        .signal-bar.active {
            opacity: 1;
            animation: barPulse 0.5s ease-in-out;
        }

        @keyframes barPulse {
            0%, 100% { transform: scaleY(1); }
            50% { transform: scaleY(1.2); }
        }

        .hopping-indicator {
            position: absolute;
            top: 5px;
            width: 10px;
            height: 10px;
            background: #ffd700;
            border-radius: 50%;
            box-shadow: 0 0 10px #ffd700;
            opacity: 0;
        }

        .hopping-indicator.active {
            animation: hop 2s linear infinite;
        }

        @keyframes hop {
            0% { left: 5%; opacity: 1; }
            100% { left: 95%; opacity: 1; }
        }

        .blueprint {
            position: absolute;
            bottom: 30px;
            right: 30px;
            width: 150px;
            height: 120px;
            background: rgba(173, 216, 230, 0.1);
            border: 2px solid #4682b4;
            transform: rotate(5deg);
        }

        /* Hedy Lamarr Character */
        .hedy-character {
            position: absolute;
            top: 45%;
            left: 20%;
            transform: translateY(-50%);
            width: 185px;
            height: 260px;
            z-index: 5;
            background-image: url('../../assets/Characterpurple.png');
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
        }

        /* Player Character */
        .player {
            position: absolute;
            bottom: 30%;
            right: 20%;
            width: 80px;
            height: 120px;
            z-index: 100;
            opacity: 0;
            animation: playerAppear 1s ease-out 5s forwards;
            background-image: url('../../assets/Characterblue.png');
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
        }

        @keyframes playerAppear {
            0% { opacity: 0; transform: scale(0.5) translateY(-50px); }
            50% { opacity: 1; transform: scale(1.2) translateY(-10px); }
            100% { opacity: 1; transform: scale(1) translateY(0); }
        }

        .player::before {
            display: none;
        }

        /* Dialogue Box */
        :root {
            --dialog-duration: 0.18s; /* snappy default */
            --dialog-ease: cubic-bezier(.2,.9,.2,1);
            --dialog-opacity-duration: 0.12s;
        }
        .dialogue-box {
            position: absolute;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%) translateY(-6px);
            width: 85%;
            max-width: 700px;
            background: rgba(10, 10, 10, 0.95);
            border: 4px solid #ffd700;
            border-radius: 15px;
            padding: 25px;
            color: #ffffff;
            display: none;
            z-index: 1000;
            opacity: 0;
            transition: transform var(--dialog-duration) var(--dialog-ease), opacity var(--dialog-opacity-duration) var(--dialog-ease);
            box-shadow: 0 0 30px rgba(255, 215, 0, 0.3);
        }

        .dialogue-box.active {
            display: block;
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        .dialogue-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #ffd700;
        }

        .dialogue-portrait {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #8b0000 0%, #5a0000 100%);
            border-radius: 50%;
            border: 3px solid #ffd700;
            margin-right: 15px;
        }

        .dialogue-name {
            font-size: 1.3rem;
            font-weight: bold;
            color: #ffd700;
        }

        .dialogue-text {
            font-size: 1.1rem;
            line-height: 1.8;
            margin-bottom: 15px;
            white-space: pre-wrap;
        }

        .dialogue-text code {
            display: block;
            background: #1a1a1a;
            border: 2px solid #333;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            font-family: 'Courier New', monospace;
            font-size: 1rem;
            line-height: 1.6;
            color: #e0e0e0;
        }

        .dialogue-text .code-keyword {
            color: #569cd6;
            font-weight: bold;
        }

        .dialogue-text .code-number {
            color: #b5cea8;
        }

        .dialogue-text .code-operator {
            color: #d4d4d4;
        }

        .dialogue-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
        }

        .dialogue-btn {
            background: linear-gradient(135deg, #8b0000 0%, #5a0000 100%);
            border: 2px solid #ffd700;
            color: #ffffff;
            padding: 12px 30px;
            font-size: 1rem;
            font-weight: bold;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Courier New', monospace;
        }

        .dialogue-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 215, 0, 0.5);
            background: linear-gradient(135deg, #9b0000 0%, #6a0000 100%);
        }

        /* Frequency Puzzle Interface */
        .frequency-puzzle {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.92);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .frequency-puzzle.active {
            display: flex;
        }

        .puzzle-panel {
            background: linear-gradient(135deg, #2a2a2a 0%, #1a1a1a 100%);
            border: 5px solid #ffd700;
            border-radius: 20px;
            padding: 30px;
            max-width: 900px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(255, 215, 0, 0.3);
        }

        .puzzle-title {
            font-size: 1.8rem;
            color: #ffd700;
            text-align: center;
            margin-bottom: 10px;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
        }

        .puzzle-instruction {
            color: #ffffff;
            text-align: center;
            font-size: 1.1rem;
            margin-bottom: 30px;
            line-height: 1.6;
        }

        .pattern-requirement {
            background: rgba(139, 0, 0, 0.3);
            border: 2px solid #ffd700;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 25px;
            color: #ffd700;
            text-align: center;
            font-size: 1rem;
        }

        .frequency-builder {
            background: rgba(42, 42, 42, 0.8);
            border: 3px solid #4a4a4a;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .loop-construction {
            background: #1a1a1a;
            border: 2px solid #3a3a3a;
            border-radius: 10px;
            padding: 20px;
            font-family: 'Courier New', monospace;
        }

        .loop-line {
            display: flex;
            align-items: center;
            gap: 15px;
            margin: 15px 0;
            min-height: 60px;
        }

        .loop-line.indented {
            padding-left: 40px;
        }

        .code-label {
            color: #569cd6;
            font-size: 1.1rem;
            font-weight: bold;
            min-width: 80px;
        }

        .code-slot {
            flex: 1;
        }

        .drop-zone {
            min-width: 250px;
            min-height: 50px;
            background: #2a2a2a;
            border: 2px dashed #4a4a6a;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 10px;
            transition: all 0.3s ease;
        }

        .drop-zone.filled {
            border-style: solid;
            border-color: #51cf66;
            background: rgba(81, 207, 102, 0.1);
        }

        .drop-zone.valid-drop {
            border-color: #00ff00;
            background: rgba(0, 255, 0, 0.2);
        }

        .code-block {
            background: linear-gradient(135deg, #8b0000 0%, #5a0000 100%);
            border: 3px solid #ffd700;
            border-radius: 8px;
            padding: 12px 20px;
            color: #e0e0e0;
            font-size: 1rem;
            font-family: 'Courier New', monospace;
            cursor: move;
            user-select: none;
            transition: all 0.3s ease;
        }

        .code-block:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 20px rgba(255, 215, 0, 0.5);
        }

        .code-block.dragging {
            opacity: 0.5;
        }

        .code-block.used {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .year-display {
            background: #1a1a1a;
            border: 3px solid #4a4a6a;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            text-align: center;
        }

        .year-counter {
            font-size: 1.5rem;
            color: #ffd700;
            font-weight: bold;
        }

        .year-counter span {
            font-size: 2rem;
            color: #51cf66;
        }

        .test-btn {
            display: block;
            margin: 10px auto;
            background: linear-gradient(135deg, #4a4a6a 0%, #2a2a4a 100%);
            border: 3px solid #ffd700;
            color: #ffffff;
            padding: 12px 40px;
            font-size: 1.1rem;
            font-weight: bold;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Courier New', monospace;
        }

        .test-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 20px rgba(255, 215, 0, 0.4);
        }

        .test-btn:disabled {
            background: #333;
            cursor: not-allowed;
            opacity: 0.5;
        }

        .execute-btn {
            display: block;
            margin: 10px auto 0;
            background: linear-gradient(135deg, #ffd700 0%, #ffaa00 100%);
            border: 3px solid #8b7355;
            color: #1a1a1a;
            padding: 15px 50px;
            font-size: 1.3rem;
            font-weight: bold;
            border-radius: 30px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Courier New', monospace;
            text-transform: uppercase;
        }

        .execute-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 25px rgba(255, 215, 0, 0.5);
        }

        .execute-btn:disabled {
            background: #555;
            cursor: not-allowed;
            opacity: 0.5;
            border-color: #333;
        }

        .builder-title {
            color: #ffd700;
            font-size: 1.2rem;
            margin-bottom: 15px;
            text-align: center;
        }

        .sequence-slots {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .frequency-slot {
            width: 80px;
            height: 80px;
            background: #1a1a1a;
            border: 3px dashed #4a4a4a;
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            position: relative;
        }

        .frequency-slot::before {
            content: attr(data-position);
            position: absolute;
            top: -25px;
            font-size: 0.8rem;
            color: #888;
        }

        .frequency-slot.filled {
            border-style: solid;
            border-color: #ffd700;
        }

        .frequency-slot.valid-drop {
            border-color: #00ff00;
            background: rgba(0, 255, 0, 0.1);
        }

        .available-frequencies {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .frequency-block {
            background: linear-gradient(135deg, #8b0000 0%, #5a0000 100%);
            border: 3px solid #ffd700;
            border-radius: 10px;
            padding: 15px 10px;
            cursor: move;
            user-select: none;
            transition: all 0.3s ease;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }

        .frequency-block:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 20px rgba(255, 215, 0, 0.5);
        }

        .frequency-block.dragging {
            opacity: 0.5;
        }

        .frequency-block.used {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .frequency-value {
            font-size: 1.4rem;
            color: #ffd700;
            font-weight: bold;
        }

        .frequency-label {
            font-size: 0.75rem;
            color: #ffffff;
        }

        .test-signal-btn {
            display: block;
            margin: 20px auto;
            background: linear-gradient(135deg, #4a4a6a 0%, #2a2a4a 100%);
            border: 3px solid #ffd700;
            color: #ffffff;
            padding: 12px 40px;
            font-size: 1.1rem;
            font-weight: bold;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Courier New', monospace;
        }

        .test-signal-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 20px rgba(255, 215, 0, 0.4);
        }

        .test-signal-btn:disabled {
            background: #333;
            cursor: not-allowed;
            opacity: 0.5;
        }

        .transmit-btn {
            display: block;
            margin: 20px auto 0;
            background: linear-gradient(135deg, #ffd700 0%, #ffaa00 100%);
            border: 3px solid #8b7355;
            color: #1a1a1a;
            padding: 15px 50px;
            font-size: 1.3rem;
            font-weight: bold;
            border-radius: 30px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Courier New', monospace;
            text-transform: uppercase;
        }

        .transmit-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 25px rgba(255, 215, 0, 0.6);
        }

        .transmit-btn:disabled {
            background: #555;
            cursor: not-allowed;
            opacity: 0.5;
        }

        /* Pattern Analysis */
        .pattern-analysis {
            background: rgba(0, 0, 0, 0.6);
            border: 2px solid #4a4a4a;
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
            display: none;
        }

        .pattern-analysis.visible {
            display: block;
        }

        .analysis-item {
            display: flex;
            justify-content: space-between;
            margin: 10px 0;
            color: #ffffff;
        }

        .analysis-label {
            color: #aaa;
        }

        .analysis-value {
            font-weight: bold;
        }

        .analysis-value.good {
            color: #00ff00;
        }

        .analysis-value.bad {
            color: #ff0000;
        }

        /* Success Flash */
        .success-flash {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, rgba(255, 215, 0, 0.8) 0%, transparent 70%);
            opacity: 0;
            pointer-events: none;
            z-index: 2500;
        }

        .success-flash.active {
            animation: flashSuccess 1.5s ease-out;
        }

        @keyframes flashSuccess {
            0%, 100% { opacity: 0; }
            50% { opacity: 1; }
        }

        /* HUD */
        .hud {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(10, 10, 10, 0.9);
            border: 3px solid #ffd700;
            border-radius: 10px;
            padding: 15px;
            z-index: 1500;
        }

        .hud-title {
            color: #ffd700;
            font-size: 0.9rem;
            margin-bottom: 10px;
            text-align: center;
        }

        .repair-progress {
            display: flex;
            gap: 5px;
        }

        .repair-piece {
            width: 30px;
            height: 30px;
            border: 2px solid #3a3a3a;
            border-radius: 5px;
            background: #1a1a1a;
            transition: all 0.5s ease;
        }

        .repair-piece.active {
            background: linear-gradient(135deg, #ffd700 0%, #ffaa00 100%);
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.8);
            animation: piecePulse 1s ease-out;
            cursor: pointer;
        }

        .repair-piece.active:hover {
            transform: scale(1.1);
            box-shadow: 0 0 20px rgba(255, 215, 0, 1);
        }

        @keyframes piecePulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2); }
        }

        .logout-btn {
            margin-top: 10px;
            width: 100%;
            padding: 8px;
            background: linear-gradient(135deg, #8b0000 0%, #ff4444 100%);
            border: 2px solid #ffd700;
            border-radius: 5px;
            color: #ffffff;
            font-size: 0.85rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Courier New', monospace;
        }

        .logout-btn:hover {
            background: linear-gradient(135deg, #a00000 0%, #ff5555 100%);
            box-shadow: 0 0 10px rgba(255, 68, 68, 0.5);
            transform: translateY(-2px);
        }

        /* slideUp keyframes removed â€” dialog now uses transform+opacity transitions */
    </style>
</head>
<body>
    <!-- Level Transition Screen -->
    <div class="level-transition" id="levelTransition">
        <h1 class="transition-title">âš¡ INTERMEDIATE LEVEL âš¡</h1>
        <p class="transition-message">
            You've mastered the fundamentals! The pioneers are impressed with your progress.<br>
            Now, face more complex challenges that will test your growing programming skills.
        </p>
        <div class="achievements-earned">
            <div class="achievement">
                <span class="achievement-icon">âœ“</span>
                <span>Print Master (Ada Lovelace)</span>
            </div>
            <div class="achievement">
                <span class="achievement-icon">âœ“</span>
                <span>Bug Hunter (Grace Hopper)</span>
            </div>
            <div class="achievement">
                <span class="achievement-icon">âœ“</span>
                <span>Logic Builder (Alan Turing)</span>
            </div>
        </div>
    </div>

    <div id="game-container">
        <!-- Studio Aesthetic -->
        <div class="studio-overlay"></div>
        <div class="spotlight spotlight-1"></div>
        
        <!-- Studio Props -->
        <div class="film-reel">
            <div class="reel-hole" style="top: 15px; left: 15px;"></div>
            <div class="reel-hole" style="top: 15px; right: 15px;"></div>
            <div class="reel-hole" style="bottom: 15px; left: 15px;"></div>
            <div class="reel-hole" style="bottom: 15px; right: 15px;"></div>
        </div>
        <div class="camera"></div>

        <!-- Workbench -->
        <div class="workbench">
            <div class="bench-surface">
                <div class="radio-receiver">
                    <div class="radio-dial"></div>
                    <div class="radio-screen" id="radioScreen">
                        AWAITING SIGNAL...
                    </div>
                </div>
                <div class="frequency-display">
                    <div class="hopping-indicator" id="hoppingIndicator"></div>
                    <div class="signal-wave" id="signalWave">
                        <div class="signal-bar" style="height: 20%;"></div>
                        <div class="signal-bar" style="height: 40%;"></div>
                        <div class="signal-bar" style="height: 60%;"></div>
                        <div class="signal-bar" style="height: 80%;"></div>
                        <div class="signal-bar" style="height: 100%;"></div>
                        <div class="signal-bar" style="height: 70%;"></div>
                        <div class="signal-bar" style="height: 50%;"></div>
                        <div class="signal-bar" style="height: 30%;"></div>
                    </div>
                </div>
                <div class="blueprint"></div>
            </div>
        </div>

        <!-- Hedy Lamarr Character -->
        <div class="hedy-character"></div>

        <!-- Player Character -->
        <div class="player"></div>

        <!-- Dialogue Box -->
        <div class="dialogue-box" id="dialogueBox">
            <div class="dialogue-header">
                <div class="dialogue-portrait"></div>
                <div class="dialogue-name">Hedy Lamarr</div>
            </div>
            <div class="dialogue-text" id="dialogueText"></div>
            <div class="dialogue-buttons" id="dialogueButtons"></div>
        </div>

        <!-- HUD -->
        <div class="hud">
            <div class="hud-title">Time Machine Repair</div>
            <div class="repair-progress">
                <div class="repair-piece" id="piece1" data-scene="SceneOne.html"></div>
                <div class="repair-piece" id="piece2" data-scene="SceneTwo.html"></div>
                <div class="repair-piece" id="piece3" data-scene="SceneThree.html"></div>
                <div class="repair-piece" id="piece4" data-scene="SceneFour.html"></div>
                <div class="repair-piece" id="piece5" data-scene="SceneFive.html"></div>
                <div class="repair-piece" id="piece6" data-scene="SceneSix.html"></div>
                <div class="repair-piece" id="piece7" data-scene="SceneSeven.html"></div>
                <div class="repair-piece" id="piece8" data-scene="SceneEight.html"></div>
            </div>
            <button class="logout-btn" onclick="handleLogout()">Logout</button>
        </div>
    </div>

    <!-- Frequency Puzzle Interface -->
    <div class="frequency-puzzle" id="frequencyPuzzle">
        <div class="puzzle-panel">
            <h2 class="puzzle-title">TIME MACHINE YEAR CALIBRATION</h2>
            <p class="puzzle-instruction">
                Build a while loop to fix the time machine's year counter.<br>
                Current year: <span style="color: #ff6b6b;">1956</span> â†’ Target year: <span style="color: #51cf66;">1963</span>
            </p>

            <div class="pattern-requirement">
                <strong>Goal:</strong> Add 1 year repeatedly while year < 1963
            </div>

            <div class="frequency-builder">
                <div class="builder-title">Build Your Loop</div>
                <div class="loop-construction">
                    <div class="loop-line">
                        <span class="code-label">Start:</span>
                        <div class="code-slot" data-slot="init">
                            <div class="drop-zone" data-type="init"></div>
                        </div>
                    </div>
                    <div class="loop-line">
                        <span class="code-label">While:</span>
                        <div class="code-slot" data-slot="condition">
                            <div class="drop-zone" data-type="condition"></div>
                        </div>
                    </div>
                    <div class="loop-line indented">
                        <span class="code-label">Do:</span>
                        <div class="code-slot" data-slot="action">
                            <div class="drop-zone" data-type="action"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="builder-title">Available Code Blocks</div>
            <div class="available-frequencies" id="availableFrequencies">
                <div class="frequency-block code-block" draggable="true" data-command="year = 1956" data-type="init">year = 1956</div>
                <div class="frequency-block code-block" draggable="true" data-command="year < 1963" data-type="condition">year &lt; 1963</div>
                <div class="frequency-block code-block" draggable="true" data-command="year = year + 1" data-type="action">year = year + 1</div>
                
                <!-- Incorrect options -->
                <div class="frequency-block code-block" draggable="true" data-command="year = 1963" data-type="init">year = 1963</div>
                <div class="frequency-block code-block" draggable="true" data-command="year > 1963" data-type="condition">year &gt; 1963</div>
                <div class="frequency-block code-block" draggable="true" data-command="year = year - 1" data-type="action">year = year - 1</div>
            </div>

            <div class="year-display" id="yearDisplay">
                <div class="year-counter">Current Year: <span id="currentYear">1956</span></div>
            </div>

            <button class="test-btn" id="testBtn" disabled>Test Loop</button>
            <button class="execute-btn" id="executeBtn" disabled>Run Time Machine</button>
        </div>
    </div>

    <!-- Success Flash -->
    <div class="success-flash" id="successFlash"></div>

    <script>
        // Game state
        let gameState = {
            arrivedInStudio: false,
            metHedy: false,
            puzzleActive: false,
            puzzleSolved: false,
            loopParts: {
                init: null,
                condition: null,
                action: null
            },
            correctSolution: {
                init: 'year = 1956',
                condition: 'year < 1963',
                action: 'year = year + 1'
            }
        };

        // DOM elements
        const dialogueBox = document.getElementById('dialogueBox');
        const dialogueText = document.getElementById('dialogueText');
        const dialogueButtons = document.getElementById('dialogueButtons');
        const frequencyPuzzle = document.getElementById('frequencyPuzzle');
        const testBtn = document.getElementById('testBtn');
        const executeBtn = document.getElementById('executeBtn');
        const successFlash = document.getElementById('successFlash');
        const levelTransition = document.getElementById('levelTransition');

        // Initialize
        setTimeout(() => {
            levelTransition.style.display = 'none';
            introduceHedy();
        }, 5500);

        // Initialize repair box navigation
        function initializeRepairBoxes() {
            const repairPieces = document.querySelectorAll('.repair-piece');
            repairPieces.forEach(piece => {
                piece.addEventListener('click', () => {
                    // Only navigate if the piece is active (completed)
                    if (piece.classList.contains('active')) {
                        const scene = piece.getAttribute('data-scene');
                        if (scene) {
                            window.location.href = scene;
                        }
                    }
                });
            });
        }

        // Initialize click handlers for all repair boxes
        initializeRepairBoxes();

        // Load user progress and update repair boxes
        async function loadUserProgress() {
            try {
                const user = getUserFromLocalStorage();
                if (!user || !user.id) {
                    console.warn('âš ï¸ No user found in localStorage - skipping progress load');
                    return;
                }

                console.log('ðŸ“Š Loading progress for user:', user.id);
                const token = localStorage.getItem('token');
                const response = await fetch(`http://localhost:3001/api/progress/${user.id}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const progressData = await response.json();
                    console.log('ðŸ“¦ Progress data received:', progressData);

                    let activatedCount = 0;
                    progressData.forEach(level => {
                        if (level.completed) {
                            const piece = document.getElementById(`piece${level.level_id}`);
                            if (piece) {
                                if (!piece.classList.contains('active')) {
                                    piece.classList.add('active');
                                    activatedCount++;
                                    console.log(`âœ… Activated piece ${level.level_id}`);
                                } else {
                                    console.log(`â„¹ï¸ Piece ${level.level_id} already active`);
                                }
                            } else {
                                console.error(`âŒ Piece element not found: piece${level.level_id}`);
                            }
                        }
                    });
                    console.log(`âœ… Progress loaded: ${progressData.length} levels completed, ${activatedCount} pieces activated`);
                } else {
                    console.error('âŒ Failed to load progress:', response.status, response.statusText);
                }
            } catch (error) {
                console.error('âŒ Error loading user progress:', error);
            }
        }

        // Ensure DOM is loaded before initializing progress
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', loadUserProgress);
        } else {
            loadUserProgress();
        }

        function introduceHedy() {
            gameState.arrivedInStudio = true;
            setTimeout(() => {
                const part1 = "Oh no â€” the time machine dropped us in the wrong year! It was supposed to bring us to 1963, the year the Equal Pay Act was signed.";
                
                const part2 = "The Equal Pay Act (1963) made it illegal to pay women less than men for the same work. It became one of the first big steps toward workplace equality.";
                
                const part3 = "But the machine thinks it's still 1954â€¦ and the timeline will stay broken unless we fix it. To reach 1963, we need to make the machine add years over and over until it gets to the correct one.";
                
                const showPart2 = () => {
                    showDialogue(part2, [{ text: "Next", action: showPart3 }]);
                };
                
                const showPart3 = () => {
                    showDialogue(part3, [{ text: "Let's fix the timeline!", action: explainInvention }]);
                };
                
                showDialogue(part1, [{ text: "Next", action: showPart2 }]);
            }, 500);
        }

        function explainInvention() {
            const loopExplanation = `The machine can't move forward one year at a time â€” that would take forever.

Instead, we'll use a loop.

A loop lets us repeat an action automatically:

"While the year is less than 1963, add 1 year."

This way, the machine will keep adding years until it reaches the correct date all by itself.

Before you try it, here's a simple example:`;

            const codeExample = `<code><span class="code-keyword">year</span> <span class="code-operator">=</span> <span class="code-number">1</span>
<span class="code-keyword">while</span> <span class="code-keyword">year</span> <span class="code-operator">&lt;</span> <span class="code-number">5</span><span class="code-operator">:</span>
    <span class="code-keyword">year</span> <span class="code-operator">=</span> <span class="code-keyword">year</span> <span class="code-operator">+</span> <span class="code-number">1</span></code>`;

            showDialogue(
                loopExplanation + codeExample,
                [{ text: "Let's fix the year!", action: startPuzzle }]
            );
        }

        function startPuzzle() {
            hideDialogue();
            gameState.puzzleActive = true;
            frequencyPuzzle.classList.add('active');
            initializeDragAndDrop();
        }

        // Drag and Drop System
        let draggedElement = null;

        function initializeDragAndDrop() {
            const blocks = document.querySelectorAll('.code-block');
            const dropZones = document.querySelectorAll('.drop-zone');
            
            blocks.forEach(block => {
                block.addEventListener('dragstart', handleDragStart);
                block.addEventListener('dragend', handleDragEnd);
            });

            dropZones.forEach(zone => {
                zone.addEventListener('dragover', handleDragOver);
                zone.addEventListener('drop', handleDrop);
                zone.addEventListener('dragleave', handleDragLeave);
            });

            testBtn.addEventListener('click', testLoop);
            executeBtn.addEventListener('click', runTimeMachine);
        }

        function handleDragStart(e) {
            if (this.classList.contains('used')) return;
            draggedElement = this;
            this.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
        }

        function handleDragEnd(e) {
            this.classList.remove('dragging');
        }

        function handleDragOver(e) {
            if (!draggedElement) return;
            
            e.preventDefault();
            const dropType = this.getAttribute('data-type');
            const blockType = draggedElement.getAttribute('data-type');
            
            if (dropType === blockType) {
                this.classList.add('valid-drop');
                e.dataTransfer.dropEffect = 'move';
            }
            return false;
        }

        function handleDragLeave(e) {
            this.classList.remove('valid-drop');
        }

        function handleDrop(e) {
            e.stopPropagation();
            e.preventDefault();
            
            this.classList.remove('valid-drop');
            
            if (!draggedElement) return;
            
            const dropType = this.getAttribute('data-type');
            const blockType = draggedElement.getAttribute('data-type');
            const command = draggedElement.getAttribute('data-command');
            
            // Validate drop type matches
            if (dropType !== blockType) return;
            
            // Clear existing content
            if (this.classList.contains('filled')) {
                this.innerHTML = '';
            }
            
            // Clone and place the block
            const clonedBlock = draggedElement.cloneNode(true);
            clonedBlock.draggable = false;
            clonedBlock.style.cursor = 'pointer';
            clonedBlock.style.margin = '0';
            
            // Add click to remove
            clonedBlock.addEventListener('click', function() {
                this.parentElement.innerHTML = '';
                this.parentElement.classList.remove('filled');
                gameState.loopParts[dropType] = null;
                updateUI();
            });
            
            this.innerHTML = '';
            this.appendChild(clonedBlock);
            this.classList.add('filled');
            
            // Update game state
            gameState.loopParts[dropType] = command;
            
            // Mark original as used
            draggedElement.classList.add('used');
            
            updateUI();
        }            this.appendChild(clonedBlock);
            this.classList.add('filled');
            this.setAttribute('data-freq', frequency);
        function updateUI() {
            const allFilled = gameState.loopParts.init && gameState.loopParts.condition && gameState.loopParts.action;
            testBtn.disabled = !allFilled;
            
            if (!allFilled) {
                executeBtn.disabled = true;
            }
        }

        function testLoop() {
            // Check if the loop is correct
            const correct = 
                gameState.loopParts.init === gameState.correctSolution.init &&
                gameState.loopParts.condition === gameState.correctSolution.condition &&
                gameState.loopParts.action === gameState.correctSolution.action;
            
            if (correct) {
                // Simulate the loop
                let year = 1956;
                const yearDisplay = document.getElementById('currentYear');
                let count = 0;
                
                const interval = setInterval(() => {
                    if (year < 1963) {
                        year++;
                        yearDisplay.textContent = year;
                        count++;
                    } else {
                        clearInterval(interval);
                        executeBtn.disabled = false;
                        yearDisplay.style.color = '#51cf66';
                    }
                }, 300);
            } else {
                alert('Your loop isn\'t quite right. Make sure you:\n1. Start at year = 1956\n2. Loop while year < 1963\n3. Add 1 to the year each time');
                // Reset display
                document.getElementById('currentYear').textContent = '1956';
                document.getElementById('currentYear').style.color = '#51cf66';
            }
        }

        function runTimeMachine() {
            puzzleSolved();
        }

        function puzzleSolved() {
            gameState.puzzleSolved = true;
            
            // Flash effect
            successFlash.classList.add('active');
            setTimeout(() => {
                successFlash.classList.remove('active');
            }, 1500);
            
            // Repair time machine piece
            setTimeout(() => {
                document.getElementById('piece4').classList.add('active');
                
                setTimeout(() => {
                    frequencyPuzzle.classList.remove('active');
                    completeScene();
                }, 2000);
            }, 1000);
        }

        function completeScene() {
            showDialogue(
                "Perfect! The time machine is now calibrated to 1963. You've mastered loops â€” one of the most powerful tools in programming. Loops let you repeat actions efficiently, and you'll use them everywhere in coding!",
                [{ text: "What's next?", action: showFarewell }]
            );
        }

        function showFarewell() {
            showDialogue(
                "The Equal Pay Act of 1963 was a major milestone. Continue your journey to learn more about the pioneers who fought for equality and built the foundations of computer science!",
                [{ text: "Continue Journey â†’", action: goToNextScene }]
            );
        }

        async function goToNextScene() {
            // Update progress to 50% (level 4 completed)
            try {
                const user = getUserFromLocalStorage();
                if (user && user.id) {
                    // FIXED: Use the correct level-based endpoint (Level 4)
                    await updateUserProgress(user.id, 4, 100, true);
                    console.log('âœ… Level 4 Progress Saved');
                }
            } catch (error) {
                console.error('âŒ Error updating progress:', error);
            }

            // Navigate to the next scene
            setTimeout(() => {
                window.location.href = 'SceneFive.html';
            }, 500);
        }

        // Helper function to update user progress
        async function updateUserProgress(userId, levelId, score, completed) {
            const API_BASE_URL = 'http://localhost:3001';
            const token = localStorage.getItem('token');

            const response = await fetch(`${API_BASE_URL}/api/progress/${userId}/level/${levelId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({ score, completed })
            });

            if (!response.ok) {
                throw new Error('Failed to update progress');
            }

            return response.json();
        }

        // Dialogue system
        function showDialogue(text, buttons) {
            dialogueText.innerHTML = text;
            dialogueButtons.innerHTML = '';
            
            buttons.forEach(btn => {
                const button = document.createElement('button');
                button.className = 'dialogue-btn';
                button.textContent = btn.text;
                button.onclick = btn.action;
                dialogueButtons.appendChild(button);
            });
            
            dialogueBox.classList.add('active');
        }

        function hideDialogue() {
            dialogueBox.classList.remove('active');
        }

        // Helper function to get user from localStorage
        function getUserFromLocalStorage() {
            try {
                const userStr = localStorage.getItem('user');
                if (!userStr) return null;
                return JSON.parse(userStr);
            } catch (error) {
                console.error('Error parsing user from localStorage:', error);
                return null;
            }
        }

        // Logout function
        function handleLogout() {
            // Clear localStorage
            localStorage.removeItem('token');
            localStorage.removeItem('userId');
            localStorage.removeItem('username');
            
            // Redirect to start screen
            window.location.href = '../StartScreen.html';
        }
    </script>
</body>
</html>