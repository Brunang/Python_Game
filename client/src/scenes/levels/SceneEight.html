<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SHE<Codes/> - Journey Complete</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Courier New', monospace;
            background: #0a0a0a;
            overflow: hidden;
            height: 100vh;
        }

        /* Game Container */
        #game-container {
            position: relative;
            width: 100vw;
            height: 100vh;
            background: url('../../assets/basement.png') center center no-repeat;
            background-size: cover;
            background-color: #1a1a1a;
        }

        /* Characters */
        .character {
            position: absolute;
            width: 200px;
            height: auto;
            z-index: 5;
        }

        .character img {
            width: 100%;
            height: auto;
            display: block;
            filter: drop-shadow(0 4px 6px rgba(0,0,0,0.25));
        }

        .left-character {
            bottom: 25%;
            left: 15%;
        }

        .player-character {
            bottom: 25%;
            right: 15%;
        }

        /* Dialogue Box */
        .dialogue-box {
            position: absolute;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            width: 85%;
            max-width: 700px;
            background: rgba(10, 10, 26, 0.95);
            border: 4px solid #ffd700;
            border-radius: 15px;
            padding: 25px;
            color: #ffffff;
            display: none;
            z-index: 1000;
            box-shadow: 0 0 30px rgba(255, 215, 0, 0.4);
            opacity: 0;
            transition: opacity 0.3s ease-out;
        }

        .dialogue-box.active {
            display: block;
            animation: fadeIn 0.5s ease-out forwards;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateX(-50%) translateY(20px); }
            to { opacity: 1; transform: translateX(-50%) translateY(0); }
        }

        .dialogue-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #ffd700;
        }

        .dialogue-portrait {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #ffd700 0%, #ffaa00 100%);
            border-radius: 50%;
            border: 3px solid #ffd700;
            margin-right: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .dialogue-name {
            font-size: 1.3rem;
            font-weight: bold;
            color: #ffd700;
        }

        .dialogue-text {
            font-size: 1.1rem;
            line-height: 1.8;
            margin-bottom: 15px;
            color: #ffffff;
        }

        .dialogue-text strong {
            color: #ffd700;
        }

        .skills-list {
            margin: 15px 0;
            padding-left: 20px;
        }

        .skills-list li {
            margin: 8px 0;
            font-size: 1rem;
            color: #4ecdc4;
        }

        .dialogue-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
        }

        .dialogue-btn {
            background: linear-gradient(135deg, #ffd700 0%, #ffaa00 100%);
            border: 3px solid #ffd700;
            color: #000000;
            padding: 12px 35px;
            font-size: 1.1rem;
            font-weight: bold;
            border-radius: 30px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Courier New', monospace;
        }

        .dialogue-btn:hover {
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 8px 25px rgba(255, 215, 0, 0.6);
        }

        /* Time Machine Repair Progress */
        .repair-container {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(10, 10, 26, 0.85);
            border: 3px solid #ffd700;
            border-radius: 15px;
            padding: 15px;
            z-index: 100;
        }

        .repair-title {
            color: #ffd700;
            font-size: 0.85rem;
            font-weight: bold;
            text-align: center;
            margin-bottom: 10px;
            letter-spacing: 1px;
        }

        .repair-progress {
            display: flex;
            gap: 5px;
        }

        .repair-piece {
            width: 30px;
            height: 30px;
            border: 2px solid #2a2a3a;
            border-radius: 5px;
            background: #0a0a1a;
            transition: all 0.5s ease;
        }

        .repair-piece.active {
            background: linear-gradient(135deg, #ffd700 0%, #ffaa00 100%);
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.8);
            animation: glow 2s ease-in-out infinite, piecePulse 1s ease-out;
            cursor: pointer;
        }

        .repair-piece.active:hover {
            transform: scale(1.15);
            box-shadow: 0 0 25px rgba(255, 215, 0, 1);
        }

        @keyframes glow {
            0%, 100% { box-shadow: 0 0 10px rgba(255, 215, 0, 0.5); }
            50% { box-shadow: 0 0 20px rgba(255, 215, 0, 0.8); }
        }

        @keyframes piecePulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2); }
        }

        .logout-btn {
            margin-top: 10px;
            width: 100%;
            padding: 8px;
            background: linear-gradient(135deg, #8b0000 0%, #ff4444 100%);
            border: 2px solid #ffd700;
            border-radius: 5px;
            color: #ffffff;
            font-size: 0.85rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Courier New', monospace;
        }

        .logout-btn:hover {
            background: linear-gradient(135deg, #a00000 0%, #ff5555 100%);
            box-shadow: 0 0 10px rgba(255, 68, 68, 0.5);
            transform: translateY(-2px);
        }

        /* Time Machine Glow Effect */
        .time-machine-glow {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 300px;
            height: 300px;
            background: radial-gradient(circle, rgba(255, 215, 0, 0.3) 0%, transparent 70%);
            border-radius: 50%;
            animation: pulse 3s ease-in-out infinite;
            z-index: 1;
        }

        @keyframes pulse {
            0%, 100% { 
                transform: translate(-50%, -50%) scale(1);
                opacity: 0.5;
            }
            50% { 
                transform: translate(-50%, -50%) scale(1.2);
                opacity: 0.8;
            }
        }

        /* Celebration particles */
        .particles {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 10;
        }

        .particle {
            position: absolute;
            width: 10px;
            height: 10px;
            background: #ffd700;
            border-radius: 50%;
            animation: float 4s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { 
                transform: translateY(0) rotate(0deg);
                opacity: 0;
            }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { 
                transform: translateY(-100vh) rotate(360deg);
                opacity: 0;
            }
        }

        .particle:nth-child(1) { left: 10%; animation-delay: 0s; }
        .particle:nth-child(2) { left: 20%; animation-delay: 0.5s; }
        .particle:nth-child(3) { left: 30%; animation-delay: 1s; }
        .particle:nth-child(4) { left: 40%; animation-delay: 1.5s; }
        .particle:nth-child(5) { left: 50%; animation-delay: 2s; }
        .particle:nth-child(6) { left: 60%; animation-delay: 2.5s; }
        .particle:nth-child(7) { left: 70%; animation-delay: 3s; }
        .particle:nth-child(8) { left: 80%; animation-delay: 3.5s; }
        .particle:nth-child(9) { left: 90%; animation-delay: 4s; }
    </style>
</head>
<body>
    <div id="game-container">
        <!-- Time Machine Repair Progress -->
        <div class="repair-container">
            <div class="repair-title">TIME MACHINE REPAIR</div>
            <div class="repair-progress">
                <div class="repair-piece" id="piece1" data-scene="SceneOne.html"></div>
                <div class="repair-piece" id="piece2" data-scene="SceneTwo.html"></div>
                <div class="repair-piece" id="piece3" data-scene="SceneThree.html"></div>
                <div class="repair-piece" id="piece4" data-scene="SceneFour.html"></div>
                <div class="repair-piece" id="piece5" data-scene="SceneFive.html"></div>
                <div class="repair-piece" id="piece6" data-scene="SceneSix.html"></div>
                <div class="repair-piece" id="piece7" data-scene="SceneSeven.html"></div>
                <div class="repair-piece" id="piece8" data-scene="SceneEight.html"></div>
            </div>
            <button class="logout-btn" onclick="handleLogout()">Logout</button>
        </div>

        <!-- Time Machine Glow -->
        <div class="time-machine-glow"></div>

        <!-- Characters -->
        <div class="character left-character">
            <img src="../../assets/Characterpurple.png" alt="Guide Character" />
        </div>

        <!-- Celebration Particles -->
        <div class="particles">
            <div class="particle"></div>
            <div class="particle"></div>
            <div class="particle"></div>
            <div class="particle"></div>
            <div class="particle"></div>
            <div class="particle"></div>
            <div class="particle"></div>
            <div class="particle"></div>
            <div class="particle"></div>
        </div>

        <!-- Dialogue Box -->
        <div class="dialogue-box" id="dialogueBox">
            <div class="dialogue-header">
                <div class="dialogue-portrait" id="dialoguePortrait">üéâ</div>
                <div class="dialogue-name" id="dialogueName">Narrator</div>
            </div>
            <div class="dialogue-text" id="dialogueText"></div>
            <div class="dialogue-buttons" id="dialogueButtons"></div>
        </div>
    </div>

    <script>
        const dialogueBox = document.getElementById('dialogueBox');
        const dialogueText = document.getElementById('dialogueText');
        const dialogueButtons = document.getElementById('dialogueButtons');
        const dialogueName = document.getElementById('dialogueName');
        const dialoguePortrait = document.getElementById('dialoguePortrait');

        // Load user progress and update repair boxes
        async function loadUserProgress() {
            try {
                const user = getUserFromLocalStorage();
                if (!user || !user.id) {
                    console.warn('‚ö†Ô∏è No user found in localStorage - skipping progress load');
                    return;
                }

                console.log('üìä Loading progress for user:', user.id);
                const token = localStorage.getItem('token');
                const response = await fetch(`http://localhost:3001/api/progress/${user.id}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const progressData = await response.json();
                    console.log('üì¶ Progress data received:', progressData);

                    let activatedCount = 0;
                    progressData.forEach(level => {
                        if (level.completed) {
                            const piece = document.getElementById(`piece${level.level_id}`);
                            if (piece) {
                                if (!piece.classList.contains('active')) {
                                    piece.classList.add('active');
                                    activatedCount++;
                                    console.log(`‚úÖ Activated piece ${level.level_id}`);
                                } else {
                                    console.log(`‚ÑπÔ∏è Piece ${level.level_id} already active`);
                                }
                            } else {
                                console.error(`‚ùå Piece element not found: piece${level.level_id}`);
                            }
                        }
                    });
                    console.log(`‚úÖ Progress loaded: ${progressData.length} levels completed, ${activatedCount} pieces activated`);
                } else {
                    console.error('‚ùå Failed to load progress:', response.status, response.statusText);
                }
            } catch (error) {
                console.error('‚ùå Error loading user progress:', error);
            }
        }

        // Initialize repair box click handlers
        function initializeRepairBoxes() {
            const repairPieces = document.querySelectorAll('.repair-piece');
            repairPieces.forEach(piece => {
                piece.addEventListener('click', () => {
                    if (piece.classList.contains('active')) {
                        const scene = piece.getAttribute('data-scene');
                        if (scene) {
                            window.location.href = scene;
                        }
                    }
                });
            });
        }

        // Dialogue sequence
        function showDialogue(name, portrait, text, buttons) {
            dialogueName.textContent = name;
            dialoguePortrait.textContent = portrait;
            dialogueText.innerHTML = text;
            dialogueButtons.innerHTML = '';
            
            buttons.forEach(btn => {
                const button = document.createElement('button');
                button.className = 'dialogue-btn';
                button.textContent = btn.text;
                button.onclick = btn.action;
                dialogueButtons.appendChild(button);
            });
            
            dialogueBox.classList.add('active');
        }

        function hideDialogue() {
            dialogueBox.classList.remove('active');
        }

        // Dialogue sequence
        function startDialogue() {
            setTimeout(() => {
                showDialogue(
                    'Narrator',
                    'üéâ',
                    '<strong>Wow, you did amazing!</strong> You\'ve journeyed through time, met incredible pioneers, and repaired the time stream. The time machine is humming with energy, ready for whatever comes next.',
                    [{ text: 'What did I learn?', action: showSkills }]
                );
            }, 1000);
        }

        function showSkills() {
            showDialogue(
                'Narrator',
                'üìö',
                'Along the way, you mastered essential coding skills that will stay with you forever:<br><br>' +
                '<ul class="skills-list">' +
                '<li><strong>Print Statements</strong> ‚Äì Communicating with computers and displaying information</li>' +
                '<li><strong>Variables & Data Types</strong> ‚Äì Storing and managing information</li>' +
                '<li><strong>Conditionals (IF/ELSE)</strong> ‚Äì Making decisions based on logic</li>' +
                '<li><strong>Loops (FOR/WHILE)</strong> ‚Äì Repeating tasks efficiently</li>' +
                '<li><strong>Functions</strong> ‚Äì Organizing code into reusable pieces</li>' +
                '<li><strong>Arrays & Patterns</strong> ‚Äì Working with collections of data</li>' +
                '<li><strong>Error Handling (TRY/EXCEPT)</strong> ‚Äì Building resilient programs that don\'t crash</li>' +
                '</ul>',
                [{ text: 'Continue...', action: showThinking }]
            );
        }

        async function showThinking() {
            // Save progress as 100% complete
            try {
                const user = getUserFromLocalStorage();
                if (user && user.id) {
                    await updateUserProgress(user.id, 100, 'Game Complete!');
                    console.log('‚úÖ Progress saved: 100% complete!');
                }
            } catch (error) {
                console.error('Error saving progress:', error);
            }

            showDialogue(
                'Narrator',
                'üí≠',
                'You didn\'t just learn to code ‚Äì you learned to <strong>think like a programmer</strong>: breaking down problems, finding patterns, and building solutions step by step.',
                [{ text: 'What about the time machine?', action: showTimeMachine }]
            );
        }

        function showTimeMachine() {
            showDialogue(
                'Narrator',
                '‚è∞',
                'The time machine is yours to keep. Whenever you want to revisit these lessons, explore new challenges, or remember the incredible women who shaped computing history, it will be waiting for you in the basement, ready for your next adventure.',
                [{ text: 'Continue...', action: showFinal }]
            );
        }

        function showFinal() {
            showDialogue(
                'Narrator',
                'üõ°Ô∏è',
                '<strong>You are now a Guardian of Code.</strong> Use your skills wisely! üöÄ‚ú®<br><br>The future of technology is in your hands. Go forth and create amazing things!',
                [{ text: 'Return to Main Menu', action: returnToMenu }]
            );
        }

        function returnToMenu() {
            window.location.href = '../StartScreen.html';
        }

        // Helper function to get user from localStorage
        function getUserFromLocalStorage() {
            const userStr = localStorage.getItem('user');
            if (userStr) {
                try {
                    return JSON.parse(userStr);
                } catch (e) {
                    console.error('Error parsing user from localStorage:', e);
                    return null;
                }
            }
            return null;
        }

        // Helper function to update user progress
        async function updateUserProgress(userId, progressPercent, progressLabel) {
            const API_BASE_URL = 'http://localhost:3001';
            const token = localStorage.getItem('token');

            const response = await fetch(`${API_BASE_URL}/api/users/${userId}/progress`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({ 
                    progress: progressPercent,
                    progressLabel: progressLabel
                })
            });

            if (!response.ok) {
                throw new Error('Failed to update progress');
            }

            return response.json();
        }

        // Start the dialogue sequence when page loads
        window.addEventListener('load', () => {
            console.log('üéâ Journey Complete! üéâ');
            // Ensure DOM is loaded before initializing progress
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', () => {
                    loadUserProgress();
                    initializeRepairBoxes();
                    startDialogue();
                });
            } else {
                loadUserProgress();
                initializeRepairBoxes();
                startDialogue();
            }
        });

        // Logout function
        function handleLogout() {
            // Clear localStorage
            localStorage.removeItem('token');
            localStorage.removeItem('userId');
            localStorage.removeItem('username');
            
            // Redirect to start screen
            window.location.href = '../StartScreen.html';
        }
    </script>
</body>
</html>
