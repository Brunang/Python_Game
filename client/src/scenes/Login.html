<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login - SHE&lt;Codes/&gt;</title>
    <style>
        /* Reuse the StartScreen theme */
        :root{--bg1:#667eea;--bg2:#764ba2;--accent:#ffd700}
        *{box-sizing:border-box;margin:0;padding:0}
        body{font-family:'Courier New',monospace;background:linear-gradient(135deg,var(--bg1) 0%,var(--bg2) 100%);min-height:100vh;display:flex;align-items:center;justify-content:center;color:#fff}
        .card{background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.06);padding:32px;border-radius:12px;width:96%;max-width:480px;box-shadow:0 10px 40px rgba(0,0,0,0.4)}
        h1{font-size:2rem;margin-bottom:8px;text-align:center}
        p.lead{opacity:.9;text-align:center;margin-bottom:18px}
        .tabs{display:flex;gap:8px;margin-bottom:18px}
        .tab{flex:1;padding:10px;border-radius:8px;border:2px solid var(--accent);background:transparent;color:#eaeaea;cursor:pointer;text-align:center}
        .tab.active{background:var(--accent);color:var(--bg1)}
        .form{display:none}
        .form.active{display:block}
        .form-group{margin-bottom:12px}
        label{display:block;margin-bottom:6px;font-weight:bold}
        input{width:100%;padding:10px;border-radius:6px;border:2px solid var(--accent);background:rgba(255,255,255,0.04);color:#fff}
        .row{display:flex;gap:8px}
        .btn{padding:12px;border-radius:8px;border:none;cursor:pointer;font-weight:bold}
        .btn.primary{
            background:linear-gradient(135deg,#f093fb 0%,#f5576c 100%);
            color:#fff;
            font-size:1.2rem;
            padding:18px;
            width:100%;
            margin-top:8px;
        }
        .btn.alt{background:linear-gradient(135deg,#4facfe 0%,#00f2fe 100%);color:#fff}
        .muted{font-size:0.9rem;color:rgba(255,255,255,0.7);text-align:center;margin-top:12px}
        .back{position:absolute;left:20px;top:20px;color:var(--accent);cursor:pointer}
    </style>
</head>
<body>
    <div class="back" onclick="goBack()">← Back</div>
    <div class="card">
        <h1>SHE&lt;Codes/&gt;</h1>
        <p class="lead">Continue your journey — sign in or create an account.</p>

        <div id="login-form" class="form active">
            <div class="form-group">
                <label for="username">Username</label>
                <input id="username" type="text" placeholder="Your name">
            </div>
            <div class="form-group">
                <label for="password">Password</label>
                <input id="password" type="password" placeholder="Enter your password">
            </div>
            <div style="display:flex;gap:8px;margin-top:8px">
                <button class="btn primary" id="loginBtn" onclick="handleLogin()"> Login</button>
            </div>
            <div id="loginError" style="color:#ff7b7b;margin-top:8px;display:none"></div>
            <div id="loadingProgress" style="color:#ffd700;margin-top:8px;display:none;text-align:center;">
                Loading your progress...
            </div>
        </div>

        <p class="muted">By continuing you agree to learn and have fun </p>
    </div>

    <script>
        const API_URL = 'http://localhost:3001';

        function goBack(){
            // go back to StartScreen
            window.location.href = 'StartScreen.html';
        }

        // Signup option removed — only login available

        async function handleLogin(){
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const err = document.getElementById('loginError');
            const loadingProgress = document.getElementById('loadingProgress');
            const loginBtn = document.getElementById('loginBtn');
            
            err.style.display='none';
            loadingProgress.style.display='none';

            if(!username||!password){ err.textContent='Please fill all fields'; err.style.display='block'; return; }

            // Disable button during login
            loginBtn.disabled = true;
            loginBtn.textContent = 'Logging in...';

            try{
                const res = await fetch(`${API_URL}/api/users/login`,{
                    method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({username,password})
                });
                const data = await res.json();
                if(!res.ok){ 
                    err.textContent = data.error || 'Login failed'; 
                    err.style.display='block'; 
                    loginBtn.disabled = false;
                    loginBtn.textContent = 'Login';
                    return; 
                }

                localStorage.setItem('token', data.token);
                localStorage.setItem('user', JSON.stringify(data.user));

                // Show loading progress message
                loadingProgress.style.display='block';

                // Check user progress and redirect to appropriate scene
                await redirectToLastSavedSpot(data.user.id, data.token);
            }catch(e){ 
                err.textContent='Connection error: '+e.message; 
                err.style.display='block'; 
                loginBtn.disabled = false;
                loginBtn.textContent = 'Login';
            }
        }

        async function redirectToLastSavedSpot(userId, token) {
            try {
                // Fetch user data to get progress percentage
                const userRes = await fetch(`${API_URL}/api/users/${userId}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!userRes.ok) {
                    // If user not found, start from the beginning
                    window.location.href = 'IntroScene.html';
                    return;
                }

                const userData = await userRes.json();
                const progress = userData.progress || 0;
                
                // Determine the next scene based on progress percentage
                const nextScene = determineNextSceneByProgress(progress);
                window.location.href = nextScene;

            } catch (error) {
                console.error('Error fetching user data:', error);
                // Default to IntroScene if there's an error
                window.location.href = 'IntroScene.html';
            }
        }

        function determineNextSceneByProgress(progress) {
            // Map progress percentages to scenes
            // 0% = IntroScene
            // 12-15% (completed Scene 1) = SceneTwo
            // >15-25% (completed Scene 2) = SceneThree
            // >25-37.5% (completed Scene 3) = SceneFour
            // >37.5-50% (completed Scene 4) = SceneFive
            // >50-62.5% (completed Scene 5) = SceneSix
            // >62.5-75% (completed Scene 6) = SceneSeven
            // >75-87.5% (completed Scene 7) = SceneEight
            // >87.5-100% (completed all) = CreditsScreen or SceneEight
            
            if (progress === 0) {
                return 'IntroScene.html';
            } else if (progress > 0 && progress <= 12.5) {
                return 'levels/SceneOne.html';
            } else if (progress > 12.5 && progress <= 25) {
                return 'levels/SceneTwo.html';
            } else if (progress > 25 && progress <= 37.5) {
                return 'levels/SceneThree.html';
            } else if (progress > 37.5 && progress <= 50) {
                return 'levels/SceneFour.html';
            } else if (progress > 50 && progress <= 62.5) {
                return 'levels/SceneFive.html';
            } else if (progress > 62.5 && progress <= 75) {
                return 'levels/SceneSix.html';
            } else if (progress > 75 && progress <= 87.5) {
                return 'levels/SceneSeven.html';
            } else {
                // 100% or close to it
                return 'levels/SceneEight.html'; // Or 'CreditsScreen.html'
            }
        }

        
    </script>
</body>
</html>
